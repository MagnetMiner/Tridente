<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>ZORD S.p.A. | CONSOLA TRIDENTE v8.0 </title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        :root {
            --bg-deep: #0A0B0C; --steel: #1A2B3C; --alert-amber: #FF9F00;
            --matrix-green: #00FF41; --hostile-red: #FF0000; --glow-blue: #00AAAA;
        }
        body { margin: 0; background: var(--bg-deep); font-family: 'Courier New', monospace; color: white; overflow: hidden; }
        
        /* Layout Monitor Dual */
        .main-container {
            display: grid;
            grid-template-columns: 1fr 400px; 
            height: 100vh;
            gap: 2px;
            background: var(--steel);
        }

        .quadrant { background: var(--bg-deep); display: flex; flex-direction: column; overflow: hidden; border: 1px solid var(--steel); }
        .q-header { 
            background: rgba(26, 43, 60, 0.8); padding: 10px 15px; font-size: 11px; 
            color: var(--glow-blue); border-bottom: 1px solid var(--steel);
            display: flex; justify-content: space-between; letter-spacing: 1px;
            text-transform: uppercase;
        }

        #map { flex-grow: 1; background: #070809; z-index: 1; }

        /* Barra Lateral */
        .side-panel { display: flex; flex-direction: column; height: 100%; border-left: 2px solid var(--steel); }
        .data-section { padding: 20px; border-bottom: 1px solid var(--steel); background: rgba(5, 7, 10, 0.5); }
        
        .log-container { flex-grow: 1; font-size: 10px; color: #8899AA; padding: 12px; overflow-y: auto; background: #050607; }
        .log-line { margin-bottom: 6px; border-left: 2px solid var(--matrix-green); padding-left: 8px; }

        /* Indicadores Visuales */
        .stat-bar { background: #111; height: 10px; margin: 8px 0; border: 1px solid var(--steel); }
        .bar-fill { height: 100%; background: var(--matrix-green); width: 0%; transition: width 0.5s; }
        .alert-text { color: var(--hostile-red); font-weight: bold; animation: blink 0.8s infinite; }
        .info-label { color: #556677; font-size: 10px; text-transform: uppercase; }
        .info-value { color: #fff; font-size: 13px; font-weight: bold; margin-bottom: 8px; display: block; }

        /* Men煤 de Acci贸n */
        #action-menu {
            position: absolute; display: none; background: rgba(10, 11, 12, 0.98); 
            border: 1px solid var(--hostile-red); padding: 12px; z-index: 5000; width: 200px;
            box-shadow: 0 0 30px rgba(255, 0, 0, 0.4);
        }
        .action-btn {
            width: 100%; background: #1a0505; color: var(--hostile-red); border: 1px solid var(--hostile-red);
            padding: 10px; cursor: pointer; margin-top: 6px; font-family: inherit; font-size: 10px; font-weight: bold;
            text-transform: uppercase;
        }
        .action-btn:hover { background: var(--hostile-red); color: white; }

        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.2; } }
        
        #boot-screen {
            position: absolute; inset: 0; background: var(--bg-deep); z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
    </style>
</head>
<body>

<div id="boot-screen">
    <div style="color: var(--matrix-green); margin-bottom: 20px; font-size: 24px; letter-spacing: 5px;">ZORD S.p.A.</div>
    <button style="background:none; border: 1px solid var(--matrix-green); color: var(--matrix-green); padding: 15px 30px; font-family: inherit; cursor: pointer;" onclick="bootSystem()">INITIALIZE MISSION TRIDENTE</button>
</div>

<div id="action-menu">
    <div style="font-size: 10px; color: var(--hostile-red); margin-bottom: 10px; text-align: center; border-bottom: 1px solid #300;">ORDEN DE ENGANCHE</div>
    <button class="action-btn" onclick="takeAction('PATRULLA DESPACHADA')">INTERCEPCIN SUPERFICIE</button>
    <button class="action-btn" style="color: var(--alert-amber); border-color: var(--alert-amber);" onclick="takeAction('ALERTA ASW ACTIVADA')">NEUTRALIZACIN ASW</button>
    <button class="action-btn" style="color: #666; border-color: #333;" onclick="closeMenu()">ABORTAR</button>
</div>

<div class="main-container">
    <div class="quadrant">
        <div class="q-header">
            <span>TSD: TACTICAL SITUATION DISPLAY</span>
            <span id="coord-display-header" style="color: var(--matrix-green);">SYS_READY</span>
        </div>
        <div id="map"></div>
    </div>

    <div class="side-panel">
        <div class="quadrant" style="height: 45%;">
            <div class="q-header"><span>B: CINEMTICA Y ANLISIS ESPECTRAL</span></div>
            <div class="data-section" id="target-hud">
                <div id="wait-msg" style="color: #445566; text-align: center; padding: 40px 0;">ESCANEO PASIVO EN CURSO...</div>
                
                <div id="target-data" style="display:none;">
                    <div class="alert-text" style="font-size: 14px; margin-bottom: 15px;">锔 CONTACTO HOSTIL DETECTADO</div>
                    
                    <span class="info-label">Ubicaci贸n GPS:</span>
                    <span class="info-value" id="side-gps">--</span>
                    
                    <div style="display: flex; justify-content: space-between;">
                        <div>
                            <span class="info-label">Rumbo:</span>
                            <span class="info-value" id="side-hdg">--</span>
                        </div>
                        <div>
                            <span class="info-label">Velocidad:</span>
                            <span class="info-value" id="side-spd">--</span>
                        </div>
                    </div>

                    <span class="info-label">Confianza de Red:</span>
                    <span class="info-value" id="side-conf" style="color: var(--matrix-green);">--</span>
                    
                    <span class="info-label">ETA Puerto m谩s cercano:</span>
                    <span class="info-value" id="side-tat">--</span>

                    <div style="font-size: 10px; color: var(--glow-blue); border-top: 1px solid #223344; pt: 5px;">
                        RIGIDEZ ESPECTRAL: <span class="alert-text">0.98</span> (OBJETO MECNICO)
                    </div>
                </div>
            </div>
        </div>

        <div class="quadrant" style="height: 20%;">
            <div class="q-header"><span>C: ESTADO DEL MOTOR Z-ENGINE</span></div>
            <div class="data-section" style="padding: 10px 20px;">
                <div style="font-size: 9px; color: #556677;">ENTROPY POOL (L-SUSY ACTIVE)</div>
                <div class="stat-bar"><div class="bar-fill" style="width: 88%;"></div></div>
                <div style="font-size: 9px; color: #556677;">EIGENVALUE ALIGNMENT</div>
                <div class="stat-bar"><div class="bar-fill" style="width: 99.9%; background: var(--glow-blue);"></div></div>
            </div>
        </div>

        <div class="quadrant" style="flex-grow: 1;">
            <div class="q-header"><span>D: MISSION LOG & SIGNATURE MATCH</span></div>
            <div id="mission-log" class="log-container"></div>
        </div>
    </div>
</div>

<script>
    const map = L.map('map', { zoomControl: false, attributionControl: false }).setView([-32.80, -72.30], 8);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { opacity: 0.8 }).addTo(map);

    const PORTS = { "VALPARASO": [-33.03, -71.62], "SAN ANTONIO": [-33.58, -71.61] };
    
    // Configuraci贸n de Boyas
    const buoys = [
        { id: "T-01", lat: -32.10, lon: -72.60 }, { id: "T-02", lat: -32.50, lon: -71.95 },
        { id: "T-03", lat: -32.90, lon: -72.55 }, { id: "T-04", lat: -33.20, lon: -72.05 },
        { id: "T-05", lat: -33.60, lon: -72.50 }
    ];

    const buoyLayers = [];
    buoys.forEach(b => {
        L.circle([b.lat, b.lon], { radius: 70000, color: '#1A2B3C', weight: 1, dashArray: '5,5', fill: false }).addTo(map);
        const pZone = L.circle([b.lat, b.lon], { radius: 35000, color: '#00FF41', weight: 1, fillOpacity: 0.03 }).addTo(map);
        L.circleMarker([b.lat, b.lon], { color: '#00FF41', radius: 2 }).addTo(map);
        buoyLayers.push({ b, pZone });
    });

    // Waypoints para que el enemigo recorra TODAS las zonas de las boyas
    const waypoints = [
        {lat: -31.80, lon: -73.00}, // Inicio
        {lat: -32.20, lon: -72.40}, // Zona T-01 / T-02
        {lat: -32.55, lon: -72.15}, // Zona T-02 / T-04
        {lat: -33.00, lon: -72.45}, // Zona T-03 / T-05
        {lat: -33.40, lon: -72.20}, // Zona T-05
        {lat: -34.50, lon: -72.80}  // Salida
    ];
    
    let currentWP = 0;
    let target = { lat: waypoints[0].lat, lon: waypoints[0].lon, heading: 0, speed: 26, marker: null, visible: false };

    function addLog(text) {
        const log = document.getElementById('mission-log');
        log.innerHTML += `<div class="log-line">[${new Date().toLocaleTimeString('en-GB')}] ${text}</div>`;
        log.scrollTop = log.scrollHeight;
    }

    function bootSystem() {
        document.getElementById('boot-screen').style.display = 'none';
        addLog("SISTEMA TRIDENTE INICIALIZADO.");
        addLog("CONEXIN CON ASMAR ESTABLECIDA (MODO PRE-ALPHA).");
        addLog("BUSCANDO VARIACIONES ESPECTRALES NO TRIVIALES...");
        
        const hostileIcon = L.divIcon({
            className: 'hostile-icon',
            html: `<div id="tgt-symbol" style="width:0; height:0; border-left:8px solid transparent; border-right:8px solid transparent; border-bottom:18px solid var(--hostile-red); filter: drop-shadow(0 0 8px red);"></div>`,
            iconSize: [16, 18], iconAnchor: [8, 9]
        });

        target.marker = L.marker([target.lat, target.lon], {icon: hostileIcon});
        target.marker.on('click', (e) => {
            const menu = document.getElementById('action-menu');
            menu.style.display = 'block';
            menu.style.left = e.originalEvent.pageX + 'px';
            menu.style.top = e.originalEvent.pageY + 'px';
        });

        setInterval(simulationLoop, 100);
    }

    function simulationLoop() {
        // L贸gica de navegaci贸n hacia Waypoints
        let wp = waypoints[currentWP + 1];
        if (!wp) return;

        let dy = wp.lat - target.lat;
        let dx = wp.lon - target.lon;
        let distToWP = Math.sqrt(dy*dy + dx*dx);

        if (distToWP < 0.05) {
            currentWP++;
            addLog(`INCURSOR ALCANZ PUNTO DE NAVEGACIN ${currentWP}.`);
        }

        target.heading = Math.atan2(dx, dy) * (180 / Math.PI);
        if (target.heading < 0) target.heading += 360;

        // Movimiento suave
        target.lat += Math.cos(target.heading * Math.PI/180) * 0.005;
        target.lon += Math.sin(target.heading * Math.PI/180) * 0.005;

        // Detecci贸n de Sensores
        let detections = 0;
        buoyLayers.forEach(l => {
            const d = map.distance([target.lat, target.lon], [l.b.lat, l.b.lon]);
            if (d < 70000) {
                detections++;
                if (d < 35000) l.pZone.setStyle({color: 'red', fillOpacity: 0.1});
                else l.pZone.setStyle({color: '#00FF41', fillOpacity: 0.03});
            } else {
                l.pZone.setStyle({color: '#00FF41', fillOpacity: 0.03});
            }
        });

        // Visibilidad y HUD
        if (detections > 0) {
            if (!target.visible) {
                target.marker.addTo(map);
                target.visible = true;
                addLog("隆ALERTA! CONTACTO CLASIFICADO COMO HOSTIL.");
                addLog("SIGNATURE MATCH: SUBMARINO SQS-53C DETECTADO.");
            }
            updateHUD(detections);
        } else {
            if (target.visible) {
                map.removeLayer(target.marker);
                target.visible = false;
                document.getElementById('target-data').style.display = 'none';
                document.getElementById('wait-msg').style.display = 'block';
                addLog("CONTACTO PERDIDO: SEAL BAJO EL PISO DE RUIDO.");
            }
        }

        if (target.visible) {
            target.marker.setLatLng([target.lat, target.lon]);
            document.getElementById('tgt-symbol').style.transform = `rotate(${target.heading}deg)`;
        }
    }

    function updateHUD(count) {
        document.getElementById('target-data').style.display = 'block';
        document.getElementById('wait-msg').style.display = 'none';
        
        document.getElementById('side-gps').innerText = `${Math.abs(target.lat).toFixed(4)}掳 S / ${Math.abs(target.lon).toFixed(4)}掳 W`;
        document.getElementById('side-hdg').innerText = Math.round(target.heading) + "掳";
        document.getElementById('side-spd').innerText = target.speed + " KTS";
        
        const confText = count > 1 ? "100% [JOINT LOCK]" : "60% [TRAZADO]";
        const confEl = document.getElementById('side-conf');
        confEl.innerText = confText;
        confEl.style.color = count > 1 ? "var(--hostile-red)" : "var(--matrix-green)";

        // TAT
        let minDist = Infinity; let port = "";
        for(let p in PORTS) {
            let d = map.distance([target.lat, target.lon], PORTS[p]);
            if(d < minDist) { minDist = d; port = p; }
        }
        document.getElementById('side-tat').innerText = `${port} (${(minDist / (target.speed * 1852)).toFixed(1)} hrs)`;
    }

    function takeAction(act) {
        addLog(`PROTOCOLO: ${act}`);
        alert(`ORDEN ENVIADA: ${act}`);
        closeMenu();
    }
    function closeMenu() { document.getElementById('action-menu').style.display = 'none'; }
</script>
</body>
</html>
