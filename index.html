<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZORD S.p.A. | CIC TRIDENTE v4.0</title>
    
    <!-- Librería Leaflet (Mapas Tácticos) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        /* ESTILO MILITAR / DARK MODE */
        body { margin: 0; padding: 0; background: #020406; font-family: 'Courier New', monospace; overflow: hidden; }
        
        #map { height: 100vh; width: 100%; z-index: 1; background: #0b0f14; }

        /* HUD TÁCTICO LATERAL */
        #hud {
            position: absolute;
            top: 20px; left: 20px; width: 340px;
            background: rgba(5, 10, 15, 0.95);
            border: 1px solid #005555;
            border-left: 4px solid #00ffff; /* Cian Zord */
            padding: 20px;
            z-index: 1000;
            color: #ccffff;
            box-shadow: 0 0 25px rgba(0, 255, 255, 0.15);
            backdrop-filter: blur(5px);
        }

        h1 { margin: 0 0 5px 0; font-size: 20px; color: #00ffff; letter-spacing: 2px; text-shadow: 0 0 10px rgba(0, 255, 255, 0.5); }
        h2 { margin: 0 0 15px 0; font-size: 11px; color: #668888; text-transform: uppercase; border-bottom: 1px solid #334444; padding-bottom: 5px;}

        /* BLOQUES DE DATOS */
        .data-block { margin-bottom: 10px; background: rgba(0, 255, 255, 0.05); padding: 8px; border-radius: 4px; }
        .label { font-size: 10px; color: #55aaaa; display: block; margin-bottom: 2px; }
        .value { font-size: 14px; font-weight: bold; color: #fff; letter-spacing: 1px; }
        
        .alert { color: #ff3333; animation: flash 0.5s infinite; }
        .safe { color: #00ff00; }
        .sub { color: #ff00ff; } /* Magenta para Submarinos */

        /* BOTÓN DE ACCIÓN */
        button {
            width: 100%; background: #002a3a; color: #00ffff; border: 1px solid #00ffff;
            padding: 12px; cursor: pointer; margin-top: 15px; font-family: inherit; font-weight: bold; text-transform: uppercase;
            transition: all 0.3s;
        }
        button:hover { background: #00ffff; color: #000; box-shadow: 0 0 20px #00ffff; }

        @keyframes flash { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }

        /* Estilos Mapa */
        .buoy-label { background: none; border: none; color: #00ffff; font-weight: bold; text-shadow: 0 0 3px #000; font-size: 10px; }
    </style>
</head>
<body>

    <div id="hud">
        <h1>PROYECTO TRIDENTE</h1>
        <h2>SISTEMA DE VIGILANCIA ZEE | ZORD S.p.A.</h2>

        <!-- ESTADO DE RED -->
        <div class="data-block">
            <span class="label">ESTADO DEL ESCUDO</span>
            <span class="value safe" id="net-status">ACTIVO - ESCANEO</span>
        </div>

        <!-- DATOS DEL BLANCO (TMA) -->
        <div style="border-top: 1px dashed #335555; margin: 15px 0; padding-top: 10px;">
            <div class="data-block">
                <span class="label">IDENTIFICACIÓN (ZFOLDING)</span>
                <span class="value" id="tgt-id">---</span>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div class="data-block">
                    <span class="label">POSICIÓN (GPS)</span>
                    <span class="value" id="tgt-pos" style="font-size: 11px;">---</span>
                </div>
                <div class="data-block">
                    <span class="label">DOMINIO</span>
                    <span class="value" id="tgt-dom">---</span>
                </div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <div class="data-block">
                    <span class="label">VELOCIDAD</span>
                    <span class="value" id="tgt-spd">0 kts</span>
                </div>
                <div class="data-block">
                    <span class="label">RUMBO (HDG)</span>
                    <span class="value" id="tgt-hdg">000°</span>
                </div>
            </div>
        </div>

        <div style="font-size: 10px; color: #446666; margin-top: 10px;">
            * DATOS ENCRIPTADOS PQC (Z-SUSY)
        </div>

        <button onclick="startSimulation()">INICIAR INCURSIÓN</button>
    </div>

    <div id="map"></div>

    <script>
        // 1. CONFIGURACIÓN DEL MAPA TÁCTICO
        const map = L.map('map', { zoomControl: false, attributionControl: false })
            .setView([-32.800, -72.100], 9);

        // Capa Oscura (CartoDB Dark Matter)
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
            maxZoom: 19, opacity: 0.9
        }).addTo(map);

        // Límite de Costa (Aproximado para evitar varamiento visual)
        const COAST_LIMIT_LON = -71.56; 

        // 2. DESPLIEGUE DE BOYAS (ESTRATEGIA ZIGZAG 40/80KM)
        const buoys = [
            { id: "T-01 [EXT]", lat: -32.30, lon: -72.40, desc: "Papudo Profundo" },
            { id: "T-02 [INT]", lat: -32.60, lon: -71.85, desc: "Quintero Costero" },
            { id: "T-03 [EXT]", lat: -32.90, lon: -72.45, desc: "Valparaíso Profundo" },
            { id: "T-04 [INT]", lat: -33.20, lon: -71.90, desc: "Curaumilla Costero" },
            { id: "T-05 [EXT]", lat: -33.50, lon: -72.50, desc: "San Antonio Profundo" },
            { id: "T-06 [INT]", lat: -33.80, lon: -71.95, desc: "Navidad Costero" }
        ];

        const R_PRIMARY = 35000; // 35km (Identificación)
        const R_SECONDARY = 70000; // 70km (Alerta)

        const buoyLayers = [];

        buoys.forEach(b => {
            // Zona Secundaria (Alerta - Amarillo)
            const sZone = L.circle([b.lat, b.lon], {
                color: '#ffd700', fillColor: 'transparent', weight: 1, dashArray: '4, 8', radius: R_SECONDARY
            }).addTo(map);

            // Zona Primaria (Identificación - Cian)
            const pZone = L.circle([b.lat, b.lon], {
                color: '#00ffff', fillColor: '#00ffff', fillOpacity: 0.05, weight: 1, radius: R_PRIMARY
            }).addTo(map);

            // Marcador
            L.circleMarker([b.lat, b.lon], {
                color: '#00ffff', fillColor: '#000', fillOpacity: 1, radius: 4
            }).addTo(map).bindTooltip(b.id, {permanent: true, direction: 'right', className: 'buoy-label'});

            buoyLayers.push({ data: b, pZone: pZone, sZone: sZone });
        });

        // 3. SIMULACIÓN DEL BLANCO
        let targetMarker = null;
        let simInterval = null;
        let triangulationLine = null;

        // Datos Tácticos Iniciales del Blanco
        let tgtState = {
            lat: -32.00,
            lon: -73.00,
            speed: 18.5, // Nudos
            heading: 145, // Rumbo Sureste (Hacia la costa)
            domain: "SUBMARINO", // O "SUPERFICIE"
            id: "TGT-UNK-01"
        };

        function startSimulation() {
            if(simInterval) clearInterval(simInterval);
            if(targetMarker) map.removeLayer(targetMarker);
            if(triangulationLine) map.removeLayer(triangulationLine);

            // Reiniciar estado visual
            document.getElementById('net-status').className = "value safe";
            document.getElementById('net-status').innerText = "ESCANEO ACTIVO";

            // Determinar aleatoriamente si es Submarino o Superficie para la demo
            const isSub = Math.random() > 0.5;
            tgtState.domain = isSub ? "SUBMARINO" : "SUPERFICIE";
            tgtState.id = isSub ? "S-KILO-99" : "M-VESS-04";
            
            // Posición inicial (Mar adentro)
            tgtState.lat = -32.20;
            tgtState.lon = -73.10;

            // Icono del Blanco
            const color = isSub ? '#ff00ff' : '#ff3333'; // Magenta para Sub, Rojo para Superficie hostil
            const shipIcon = L.divIcon({
                className: 'custom-icon',
                html: `<div style="
                    width: 0; height: 0; 
                    border-left: 8px solid transparent; 
                    border-right: 8px solid transparent; 
                    border-bottom: 18px solid ${color}; 
                    transform: rotate(${tgtState.heading}deg);
                    filter: drop-shadow(0 0 5px ${color});">
                </div>`,
                iconSize: [1],
                iconAnchor: [2]
            });

            targetMarker = L.marker([tgtState.lat, tgtState.lon], {icon: shipIcon}).addTo(map);

            // Bucle de Simulación (20 Hz)
            simInterval = setInterval(() => {
                updatePosition();
                checkSensors();
            }, 50);
        }

        function updatePosition() {
            // Física de movimiento simple
            const rad = tgtState.heading * (Math.PI / 180);
            
            // Velocidad simulada visualmente (factor de escala)
            const speedFactor = 0.002; 
            
            // Cálculo del siguiente paso
            let nextLat = tgtState.lat - (Math.cos(rad) * speedFactor); // Leaflet: Lat sube hacia el norte
            let nextLon = tgtState.lon + (Math.sin(rad) * speedFactor); // Lon sube hacia el este

            // --- LÓGICA DE COLISIÓN CON TIERRA ---
            // Si intenta cruzar la longitud límite de la costa, detenemos o rebotamos
            if (nextLon > COAST_LIMIT_LON) {
                clearInterval(simInterval);
                document.getElementById('net-status').innerText = "!!! INTERCEPCIÓN COSTERA !!!";
                document.getElementById('net-status').className = "value alert";
                
                // Efecto visual de detención
                L.circleMarker([tgtState.lat, tgtState.lon], {
                    radius: 20, color: 'red', fill: false, className: 'alert'
                }).addTo(map);
                
                return;
            }

            tgtState.lat = nextLat;
            tgtState.lon = nextLon;
            
            // Actualizar marcador
            targetMarker.setLatLng([tgtState.lat, tgtState.lon]);
        }

        function checkSensors() {
            let detectionCount = 0;
            let activeBuoys = [];

            buoyLayers.forEach(b => {
                const dist = map.distance([tgtState.lat, tgtState.lon], [b.data.lat, b.data.lon]);
                
                // Detección Primaria (Lock sólido)
                if (dist < R_PRIMARY) {
                    detectionCount++;
                    activeBuoys.push(b.data);
                    b.pZone.setStyle({color: '#ff3333', fillColor: '#ff3333', fillOpacity: 0.2});
                } else {
                    b.pZone.setStyle({color: '#00ffff', fillColor: '#00ffff', fillOpacity: 0.05});
                }
            });

            updateHUD(detectionCount, activeBuoys);
        }

        function updateHUD(count, activeBuoys) {
            const statusEl = document.getElementById('net-status');
            const posEl = document.getElementById('tgt-pos');
            
            // Actualizar datos cinemáticos siempre (simulando rastreo satelital/acústico)
            if (count > 0) {
                // Actualizar Panel
                document.getElementById('tgt-id').innerText = tgtState.id;
                document.getElementById('tgt-dom').innerText = tgtState.domain;
                document.getElementById('tgt-dom').className = tgtState.domain === "SUBMARINO" ? "value sub" : "value alert";
                
                document.getElementById('tgt-spd').innerText = tgtState.speed + " kts";
                document.getElementById('tgt-hdg').innerText = tgtState.heading + "°";
                
                // Formato GPS Naval (4 decimales)
                posEl.innerText = `${tgtState.lat.toFixed(4)}, ${tgtState.lon.toFixed(4)}`;

                statusEl.innerText = `CONTACTO (${count} NODOS)`;
                statusEl.className = "value alert";

                // Triangulación Visual (Líneas rojas)
                if (count >= 2) {
                    if(triangulationLine) map.removeLayer(triangulationLine);
                    // Dibujar líneas desde las 2 primeras boyas activas al blanco
                    const latlngs = [
                        [activeBuoys.lat, activeBuoys.lon],
                        [tgtState.lat, tgtState.lon],
                        [activeBuoys[3].lat, activeBuoys[3].lon]
                    ];
                    triangulationLine = L.polyline(latlngs, {color: 'red', weight: 1, dashArray: '5,5'}).addTo(map);
                }

            } else {
                // Sin detección (Datos en espera)
                document.getElementById('tgt-id').innerText = "---";
                statusEl.innerText = "ESCANEO PASIVO";
                statusEl.className = "value safe";
                if(triangulationLine) map.removeLayer(triangulationLine);
            }
        }

    </script>
</body>
</html>
