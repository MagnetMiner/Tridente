<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>ZORD S.p.A. | CIC TRIDENTE v6.0 - ENGAGEMENT MODE</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        :root { --glow: #00ffff; --alert: #ff3333; --bg: #020406; --panel: rgba(8, 12, 16, 0.9); }
        body { margin: 0; background: var(--bg); font-family: 'Courier New', monospace; overflow: hidden; color: #fff; }
        
        /* Rejilla Táctica de Fondo */
        #map { height: 100vh; width: 100%; background-image: radial-gradient(#112222 1px, transparent 1px); background-size: 30px 30px; }

        /* HUD Principal */
        #hud {
            position: absolute; top: 20px; left: 20px; width: 320px; z-index: 1000;
            background: var(--panel); border: 1px solid #005555; border-left: 4px solid var(--glow);
            padding: 15px; box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        /* Menú de Acción (Popup Táctico) */
        #action-menu {
            position: absolute; display: none; background: var(--panel); 
            border: 1px solid var(--alert); padding: 10px; z-index: 2000; width: 180px;
        }

        .stat-row { display: flex; justify-content: space-between; margin: 5px 0; font-size: 11px; }
        .stat-val { color: var(--glow); font-weight: bold; }
        .alert { color: var(--alert); animation: blink 0.8s infinite; }
        
        button {
            width: 100%; background: #003333; color: var(--glow); border: 1px solid var(--glow);
            padding: 8px; cursor: pointer; margin-top: 5px; font-family: inherit; font-size: 10px;
        }
        button:hover { background: var(--glow); color: #000; }
        button.asw { border-color: var(--alert); color: var(--alert); }
        button.asw:hover { background: var(--alert); color: #fff; }

        @keyframes blink { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
        .buoy-label { background: none; border: none; color: #446666; font-size: 9px; }
    </style>
</head>
<body>

<div id="hud">
    <div style="font-size: 14px; font-weight: bold; color: var(--glow);">ZORD TRIDENTE CIC</div>
    <div style="font-size: 9px; color: #668888; margin-bottom: 10px;">TACTICAL ENGAGEMENT SYSTEM</div>
    
    <div id="tracking-panel" style="display:none;">
        <div class="stat-row"><span>ID:</span> <span class="stat-val alert" id="tgt-id">---</span></div>
        <div class="stat-row"><span>POS:</span> <span class="stat-val" id="tgt-pos">---</span></div>
        <div class="stat-row"><span>SPD/HDG:</span> <span class="stat-val" id="tgt-motion">---</span></div>
        <div class="stat-row"><span>CONFIANZA:</span> <span class="stat-val" id="tgt-conf">---</span></div>
        <div class="stat-row"><span>TAT PROX:</span> <span class="stat-val" id="tgt-tat">---</span></div>
        <hr style="border: 0; border-top: 1px solid #224444;">
    </div>
    
    <div id="idle-msg" style="font-size: 10px; color: #446666;">MODO: ESCANEO PASIVO - SIN CONTACTOS</div>
    <button onclick="startSimulation()">INICIAR SIMULACIÓN DE INCURSIÓN</button>
</div>

<div id="action-menu">
    <div style="font-size: 10px; color: var(--alert); margin-bottom: 5px; border-bottom: 1px solid var(--alert);">OPCIONES DE RESPUESTA</div>
    <button onclick="takeAction('PATRULLA ENVIADA')">ENVIAR PATRULLA</button>
    <button class="asw" onclick="takeAction('ALERTA ASW ACTIVADA')">ENVIAR ASW</button>
</div>

<div id="map"></div>

<script>
    const map = L.map('map', { zoomControl: false, attributionControl: false }).setView([-32.800, -72.200], 8);
    const PORTS = { "VALPARAISO": [-33.03, -71.62], "SAN ANTONIO": [-33.58, -71.61] };
    const COAST_LIMIT = -71.70;

    const buoys = [
        { id: "T-01 (EXT)", lat: -32.00, lon: -72.40 }, { id: "T-02 (INT)", lat: -32.30, lon: -71.95 },
        { id: "T-03 (EXT)", lat: -32.60, lon: -72.45 }, { id: "T-04 (INT)", lat: -32.90, lon: -72.00 },
        { id: "T-05 (EXT)", lat: -33.20, lon: -72.50 }, { id: "T-06 (INT)", lat: -33.50, lon: -72.05 }
    ];

    const buoyLayers = [];
    buoys.forEach(b => {
        const pZone = L.circle([b.lat, b.lon], { color: '#00ffff', fillColor: '#00ffff', fillOpacity: 0.05, radius: 35000, weight: 1 }).addTo(map);
        const sZone = L.circle([b.lat, b.lon], { color: '#ffd700', fillColor: 'transparent', radius: 70000, weight: 1, dashArray: '4, 8' }).addTo(map);
        L.circleMarker([b.lat, b.lon], { color: '#00ffff', radius: 3 }).addTo(map).bindTooltip(b.id, {permanent: true, direction: 'top', className: 'buoy-label'});
        buoyLayers.push({ b, pZone, sZone });
    });

    let hostile = null;
    let simInterval = null;

    function startSimulation() {
        if(simInterval) clearInterval(simInterval);
        if(hostile) map.removeLayer(hostile.marker);
        
        hostile = {
            lat: -31.80, lon: -72.80, heading: 145, speed: 18, 
            id: "TGT-ECHO-1", type: "HOSTILE",
            marker: L.marker([-31.80, -72.80]).addTo(map)
        };

        hostile.marker.on('click', (e) => {
            const menu = document.getElementById('action-menu');
            menu.style.display = 'block';
            menu.style.left = e.containerPoint.x + 'px';
            menu.style.top = e.containerPoint.y + 'px';
        });

        simInterval = setInterval(updateScene, 100);
    }

    function updateScene() {
        // Movimiento (Evitando tierra)
        let nextLon = hostile.lon + Math.sin(hostile.heading * Math.PI / 180) * 0.005;
        if(nextLon > COAST_LIMIT) { hostile.heading = 190; }
        
        hostile.lat -= Math.cos(hostile.heading * Math.PI / 180) * 0.005;
        hostile.lon += Math.sin(hostile.heading * Math.PI / 180) * 0.005;

        // Actualizar icono con rotación (Punta del triángulo = Heading)
        hostile.marker.setLatLng([hostile.lat, hostile.lon]);
        const color = "#ff3333";
        hostile.marker.setIcon(L.divIcon({
            className: 't-icon',
            html: `<div style="width: 0; height: 0; border-left: 7px solid transparent; border-right: 7px solid transparent; border-bottom: 16px solid ${color}; transform: rotate(${hostile.heading}deg); filter: drop-shadow(0 0 5px ${color});"></div>`
        }));

        // Sensor Check
        let detCount = 0;
        buoyLayers.forEach(l => {
            const dist = map.distance([hostile.lat, hostile.lon], [l.b.lat, l.b.lon]);
            if(dist < 70000) detCount++;
            l.sZone.setStyle({color: (dist < 70000) ? '#ff3333' : '#ffd700'});
        });

        if(detCount > 0) {
            updateHUD(detCount);
            if(!map.hasLayer(hostile.marker)) hostile.marker.addTo(map);
        } else {
            document.getElementById('tracking-panel').style.display = 'none';
            document.getElementById('idle-msg').style.display = 'block';
            if(map.hasLayer(hostile.marker)) map.removeLayer(hostile.marker);
        }
    }

    function updateHUD(count) {
        document.getElementById('tracking-panel').style.display = 'block';
        document.getElementById('idle-msg').style.display = 'none';
        document.getElementById('tgt-id').innerText = hostile.id;
        document.getElementById('tgt-pos').innerText = `${Math.abs(hostile.lat).toFixed(3)}S / ${Math.abs(hostile.lon).toFixed(3)}W`;
        document.getElementById('tgt-motion').innerText = `${hostile.speed} KTS / ${hostile.heading}°`;
        document.getElementById('tgt-conf').innerText = count > 1 ? "100% JOINT LOCK" : "60% TRAZADO";
        
        // TAT al puerto más cercano
        let minDist = Infinity; let nearest = "";
        for(let p in PORTS) {
            let d = map.distance([hostile.lat, hostile.lon], PORTS[p]);
            if(d < minDist) { minDist = d; nearest = p; }
        }
        let hours = (minDist / (hostile.speed * 1852)) ; // Dist metros / (nudos a metros/h)
        document.getElementById('tgt-tat').innerText = `${nearest} (${hours.toFixed(1)} hrs)`;
    }

    function takeAction(msg) {
        alert(msg);
        document.getElementById('action-menu').style.display = 'none';
    }
</script>
</body>
</html>
