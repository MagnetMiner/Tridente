<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZORD SPA | UNIFIED CIC TRIDENTE v5.0 </title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        :root {
            --bg: #020406;
            --grid: #1A2B3C;
            --green: #00FF41;
            --amber: #FF9F00;
            --red: #FF3333;
            --blue: #00ffff;
            --header-h: 50px;
            --footer-h: 100px;
        }

        * { box-sizing: border-box; }
        body, html {
            margin: 0; padding: 0;
            background-color: var(--bg);
            color: var(--green);
            font-family: 'Courier New', monospace;
            height: 100vh; width: 100vw;
            overflow: hidden;
            display: flex; flex-direction: column;
        }

        /* --- COORDENADAS DINMICAS (ANID/GEOLOC) --- */
        .coord-overlay {
            position: fixed; font-size: 0.65rem; color: var(--blue); z-index: 2000;
            background: rgba(10, 11, 12, 0.9); padding: 2px 8px; border: 1px solid var(--grid);
        }
        .top-c { top: 2px; left: 50%; transform: translateX(-50%); }
        .bot-c { bottom: var(--footer-h); left: 50%; transform: translateX(-50%); }

        /* --- HEADER --- */
        header {
            height: var(--header-h); border-bottom: 2px solid var(--grid);
            display: flex; align-items: center; padding: 0 20px;
            justify-content: space-between; background: #0d1117; flex-shrink: 0;
        }

        /* --- GRID PRINCIPAL --- */
        .main-container {
            flex-grow: 1; display: grid;
            grid-template-columns: 1fr 1fr; grid-template-rows: 1.2fr 0.8fr;
            gap: 10px; padding: 10px; overflow: hidden;
        }

        .quadrant {
            border: 1px solid var(--grid); background: rgba(8, 12, 16, 0.95);
            display: flex; flex-direction: column; position: relative; overflow: hidden;
        }

        .q-title {
            background: var(--grid); color: #FFF; padding: 4px 10px;
            font-size: 0.7rem; text-transform: uppercase; z-index: 1001;
        }

        /* --- QUAD A: MAPA LEAFLET --- */
        #map { flex-grow: 1; background: #0b0f14; z-index: 1; }

        /* --- QUAD B: VISUALIZADOR HZ --- */
        iframe {
            width: 100%; height: 100%; border: none;
            filter: grayscale(1) brightness(0.6) sepia(0.4) hue-rotate(140deg);
        }

        /* --- QUAD D: MISSION LOG --- */
        #log-display { padding: 10px; font-size: 0.7rem; overflow-y: auto; flex-grow: 1; }
        .log-entry { margin-bottom: 4px; border-left: 2px solid var(--blue); padding-left: 8px; }

        /* --- FOOTER --- */
        footer {
            height: var(--footer-h); border-top: 2px solid var(--grid);
            background: #0d1117; display: flex; flex-direction: column;
            align-items: center; justify-content: center; gap: 8px; flex-shrink: 0;
        }

        .button-row { display: flex; gap: 15px; }
        button {
            background: #002a3a; color: var(--blue); border: 1px solid var(--blue);
            padding: 10px 20px; cursor: pointer; font-family: inherit; font-weight: bold;
            font-size: 0.8rem; text-transform: uppercase; transition: 0.3s;
        }
        button:hover { background: var(--blue); color: #000; box-shadow: 0 0 15px var(--blue); }
        .active-btn { background: var(--green) !important; color: #000 !important; }
        .btn-alert { border-color: var(--red); color: var(--red); }
        .btn-alert:hover { background: var(--red); color: #fff; }

        /* Icono de Objetivo Custom */
        .custom-icon { border: none; background: none; }
    </style>
</head>
<body>

    <div class="coord-overlay top-c" id="lat-top">LAT: --.---- N</div>
    <div class="coord-overlay bot-c" id="lat-bot">LAT: --.---- N</div>

    <header>
        <div>ZORD SPA // CIC TRIDENTE v5.0</div>
        <div style="color: var(--blue)">SISTEMA: <span id="sys-mode">ESCANEO PASIVO</span></div>
        <div id="clock">00:00:00</div>
    </header>

    <div class="main-container">
        <div class="quadrant">
            <div class="q-title">Tactical Situation Display [ASW Zigzag Grid]</div>
            <div id="map"></div>
        </div>

        <div class="quadrant">
            <div class="q-title">Hz-Operator Spectral Rigidity Analysis</div>
            <iframe src="https://magnetminer.github.io/Tridente/"></iframe>
        </div>

        <div class="quadrant">
            <div class="q-title">ZEngine / DEW Control Stats</div>
            <div style="padding: 15px; font-size: 0.75rem;">
                <p>CONFIDENCIA LOCK: <span id="conf-val" style="color:var(--blue)">0%</span></p>
                <div style="background: #111; height: 8px; border: 1px solid var(--grid);">
                    <div id="conf-bar" style="width: 0%; background: var(--blue); height: 100%;"></div>
                </div>
                <p>SUPRESIN RUIDO ATMOSFRICO: <span id="noise-val">94.2%</span></p>
                <p>FASE PTICA ADAPTATIVA: <span id="phase-status">LOCKED</span></p>
                <p style="margin-top: 15px; opacity: 0.5; font-size: 0.6rem;">DOI: 10.5281/zenodo.18305369 | C. CORREA AGUILERA</p>
            </div>
        </div>

        <div class="quadrant">
            <div class="q-title">Mission Operational Log</div>
            <div id="log-display"></div>
        </div>
    </div>

    <footer>
        <div class="button-row">
            <button id="bypass-btn" class="btn-alert" onclick="toggleBypass()">Bypass Z-Engine</button>
            <button id="auto-pilot-btn" onclick="toggleAutoPilot()">Iniciar Incursi贸n T谩ctica</button>
        </div>
        <div style="font-size: 0.6rem; opacity: 0.6;">* DATOS ENCRIPTADOS PQC (Z-SUSY) // PROYECTO TRIDENTE </div>
    </footer>

    <script>
        // 1. CONFIGURACIN DEL MAPA Y BOYAS (L贸gica Proyecto Tridente)
        const map = L.map('map', { zoomControl: false, attributionControl: false }).setView([-32.800, -72.200], 8);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { opacity: 0.9 }).addTo(map);

        const buoys = [
            { id: "T-01 (EXT)", lat: -32.00, lon: -72.40 },
            { id: "T-02 (INT)", lat: -32.30, lon: -71.95 },
            { id: "T-03 (EXT)", lat: -32.60, lon: -72.45 },
            { id: "T-04 (INT)", lat: -32.90, lon: -72.00 },
            { id: "T-05 (EXT)", lat: -33.20, lon: -72.50 },
            { id: "T-06 (INT)", lat: -33.50, lon: -72.05 }
        ];

        const R_PRIMARY = 35000; 
        const buoyLayers = [];

        buoys.forEach(b => {
            const pZone = L.circle([b.lat, b.lon], { 
                color: '#00ffff', fillColor: '#00ffff', fillOpacity: 0.08, radius: R_PRIMARY, weight: 1 
            }).addTo(map);
            
            L.circleMarker([b.lat, b.lon], { color: '#00ffff', fillColor: '#000', fillOpacity: 1, radius: 4 })
                .addTo(map).bindTooltip(b.id, {permanent: true, direction: 'top', className: 'buoy-label', offset: [0, -10]});
            
            buoyLayers.push({ data: b, zone: pZone });
        });

        // 2. ESTADO Y SIMULACIN (Fusi贸n ASW + DEW)
        let bypass = false;
        let autoPilot = false;
        let targetMarker = null;
        let laserLine = null;
        let tgt = { lat: -31.80, lon: -72.80, heading: 140, speed: 22 };

        function updateClock() {
            document.getElementById('clock').innerText = new Date().toLocaleTimeString();
        }
        setInterval(updateClock, 1000);

        function addLog(txt) {
            const d = document.getElementById('log-display');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.innerText = `[${new Date().toLocaleTimeString()}] > ${txt}`;
            d.prepend(entry);
        }

        function toggleAutoPilot() {
            autoPilot = !autoPilot;
            document.getElementById('auto-pilot-btn').classList.toggle('active-btn');
            if (autoPilot) {
                addLog("INICIANDO INCURSIN: TRACE-LOCK ACTIVADO.");
                if (!targetMarker) {
                    const icon = L.divIcon({
                        className: 'custom-icon',
                        html: `<div id="icon-div" style="width:0;height:0;border-left:7px solid transparent;border-right:7px solid transparent;border-bottom:15px solid var(--red);transform:rotate(${tgt.heading}deg);filter:drop-shadow(0 0 5px var(--red));"></div>`
                    });
                    targetMarker = L.marker([tgt.lat, tgt.lon], {icon: icon}).addTo(map);
                }
                runCycle();
            } else {
                addLog("INCURSIN FINALIZADA. VOLVIENDO A MODO PASIVO.");
                if(laserLine) map.removeLayer(laserLine);
                document.getElementById('sys-mode').innerText = "ESCANEO PASIVO";
            }
        }

        function toggleBypass() {
            bypass = !bypass;
            document.getElementById('bypass-btn').classList.toggle('active-btn');
            addLog(bypass ? "CRTICO: BYPASS Z-ENGINE. PRDIDA DE COHERENCIA ESPECTRAL." : "Z-ENGINE RESTAURADO. PTICA ADAPTATIVA ONLINE.");
            document.getElementById('noise-val').innerText = bypass ? "14.1%" : "94.2%";
            document.getElementById('phase-status').innerText = bypass ? "UNSTABLE" : "LOCKED";
        }

        function runCycle() {
            if (!autoPilot) return;

            // Movimiento basado en ASW - Tridente.txt [cite: 2508]
            tgt.lat -= (tgt.speed * 0.0001);
            tgt.lon += (tgt.speed * 0.00006);
            
            targetMarker.setLatLng([tgt.lat, tgt.lon]);

            // L贸gica de detecci贸n por boyas y Triangulaci贸n [cite: 2529]
            let activeBuoys = [];
            buoyLayers.forEach(b => {
                const dist = map.distance([tgt.lat, tgt.lon], [b.data.lat, b.data.lon]);
                if (dist < R_PRIMARY) {
                    b.zone.setStyle({fillColor: 'red', color: 'red', fillOpacity: 0.2});
                    activeBuoys.push(b.data);
                } else {
                    b.zone.setStyle({fillColor: '#00ffff', color: '#00ffff', fillOpacity: 0.08});
                }
            });

            // Actualizar M茅tricas y Rayo L谩ser (Fusi贸n DEW) [cite: 1749]
            const conf = activeBuoys.length > 0 ? (activeBuoys.length === 1 ? 60 : 100) : 0;
            document.getElementById('conf-val').innerText = conf + "%";
            document.getElementById('conf-bar').style.width = conf + "%";
            document.getElementById('sys-mode').innerText = conf === 100 ? "!!! JOINT LOCK !!!" : "BUSCANDO CONTACTO";

            // Dibujar Triangulaci贸n / L谩ser desde Boya T-02 si hay lock
            if (laserLine) map.removeLayer(laserLine);
            if (activeBuoys.length > 0) {
                const origin = [buoys[1].lat, buoys[1].lon]; // Boya central T-02
                const color = bypass ? 'yellow' : 'red';
                const weight = bypass ? 1 : 2;
                // Si hay bypass, el rayo "tiembla" simulando falta de 贸ptica adaptativa 
                const jitter = bypass ? (Math.random() - 0.5) * 0.05 : 0;
                laserLine = L.polyline([origin, [tgt.lat + jitter, tgt.lon + jitter]], {
                    color: color, weight: weight, dashArray: bypass ? '5, 10' : 'none'
                }).addTo(map);
            }

            setTimeout(runCycle, 100);
        }

        // Geolocalizaci贸n real para los bordes
        if (navigator.geolocation) {
            navigator.geolocation.watchPosition(p => {
                const lat = p.coords.latitude.toFixed(4);
                document.getElementById('lat-top').innerText = `LAT: ${lat} N`;
                document.getElementById('lat-bot').innerText = `LAT: ${lat} N`;
            });
        }
    </script>
</body>
</html>
