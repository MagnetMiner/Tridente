<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZORD TRIDENTE | C4I SYSTEM</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; font-family: 'Courier New', monospace; background: #000; }
        
        /* LAYOUT PRINCIPAL */
        #main-container {
            display: flex;
            height: 100vh;
            width: 100vw;
        }

        /* PANEL IZQUIERDO (UI TIPO TU IMAGEN) */
        #control-panel {
            width: 320px;
            background: #00090c;
            border-right: 2px solid #004433;
            color: #00ffcc;
            padding: 20px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            z-index: 1000;
            box-shadow: 5px 0 15px rgba(0,0,0,0.5);
        }

        /* MAPA DERECHA */
        #map-container {
            flex-grow: 1;
            position: relative;
            background: #000;
        }

        #map { height: 100%; width: 100%; background: #000; }

        /* CANVAS SUPERPUESTO AL MAPA */
        #tactical-overlay {
            position: absolute;
            top: 0; left: 0;
            pointer-events: none; /* Permite hacer click/zoom al mapa a través del canvas */
            z-index: 500;
        }

        /* ESTILOS UI */
        h1 { font-size: 22px; margin: 0 0 10px 0; text-shadow: 0 0 5px #00ffcc; border-bottom: 1px solid #004433; padding-bottom: 10px; }
        h2 { font-size: 14px; color: #008866; margin-top: 20px; margin-bottom: 5px; text-transform: uppercase; }
        .data-row { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 6px; }
        .value { color: #fff; font-weight: bold; }
        .alert { color: #ff3333; animation: blink 1s infinite; }
        .nominal { color: #00ffcc; }
        .btn {
            margin-top: 20px; background: rgba(0, 85, 68, 0.3); border: 1px solid #00ffcc; 
            color: #00ffcc; padding: 10px; cursor: pointer; width: 100%; font-family: inherit;
            transition: 0.3s;
        }
        .btn:hover { background: #00ffcc; color: #000; }

        @keyframes blink { 50% { opacity: 0.3; } }

        /* Estilo CRT para el panel */
        .scanline {
            width: 320px; height: 50px; position: absolute; top: 0; left: 0; pointer-events: none;
            background: linear-gradient(0deg, rgba(0,0,0,0) 0%, rgba(0, 255, 204, 0.05) 50%, rgba(0,0,0,0) 100%);
            animation: scan 6s linear infinite; opacity: 0.3;
        }
        @keyframes scan { 0% { top: -50px; } 100% { top: 100%; } }
    </style>
</head>
<body>

<div id="main-container">
    <div id="control-panel">
        <div class="scanline"></div>
        <h1>ZORD TRIDENTE</h1>
        <div style="font-size: 10px; color: #555;">MATRIZ ZIGZAG | DEFENSA EN PROFUNDIDAD</div>

        <h2>Estado del Sistema</h2>
        <div class="data-row"><span>SISTEMA:</span> <span class="nominal value">NOMINAL</span></div>
        <div class="data-row"><span>MODO:</span> <span class="value">ACÚSTICO PASIVO</span></div>
        <div class="data-row"><span>BOYAS ACTIVAS:</span> <span class="value">6/6</span></div>

        <h2>Datos del Contacto</h2>
        <div class="data-row"><span>ID:</span> <span class="value" id="ui-id">--</span></div>
        <div class="data-row"><span>COORD:</span> <span class="value" id="ui-coord">ESCANANDO...</span></div>
        <div class="data-row"><span>RUMBO (HDG):</span> <span class="value" id="ui-hdg">--</span></div>
        <div class="data-row"><span>VELOCIDAD:</span> <span class="value" id="ui-spd">--</span></div>
        <div class="data-row"><span>CONFIDENCE:</span> <span class="value" id="ui-conf">0%</span></div>

        <h2>Motor Matemático</h2>
        <div class="data-row"><span>EC. KOLMOGOROV:</span> <span class="nominal value">RUNNING</span></div>
        <div class="data-row"><span>METRICA Z (PAPER):</span> <span class="value">0.85 ($C_{s8}$)</span></div>
        
        <div id="alert-box" style="margin-top: 20px; border: 1px solid #333; padding: 10px; text-align: center; display: none;">
            <span class="alert">!!! CONTACTO DETECTADO !!!</span><br>
            <span style="font-size:10px">CLASE SCORPÈNE (S42)</span>
        </div>

        <button class="btn" onclick="resetSim()">REINICIAR SIMULACIÓN</button>
    </div>

    <div id="map-container">
        <div id="map"></div>
        <canvas id="tactical-overlay"></canvas>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // 1. INICIALIZAR MAPA (LEAFLET)
    // Centrado entre Los Vilos y San Antonio
    const map = L.map('map', {
        zoomControl: false,
        attributionControl: false
    }).setView([-32.75, -71.8], 9);

    // Mover controles de zoom a la derecha arriba
    L.control.zoom({ position: 'topright' }).addTo(map);

    // Capa de Mapa OSCURO (CartoDB Dark Matter) - Ideal para estilo militar
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        maxZoom: 19,
        subdomains: 'abcd'
    }).addTo(map);

    // 2. CONFIGURACIÓN DEL CANVAS OVERLAY
    const canvas = document.getElementById('tactical-overlay');
    const ctx = canvas.getContext('2d');

    function resizeCanvas() {
        canvas.width = document.getElementById('map-container').offsetWidth;
        canvas.height = document.getElementById('map-container').offsetHeight;
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    // 3. BOYAS (COORDENADAS REALES - ZIGZAG)
    // Distribución aproximada para cubrir la zona
    const buoys = [
        { id: "T-01", lat: -31.95, lon: -71.70, type: "EXT" }, // Los Vilos Norte
        { id: "T-02", lat: -32.20, lon: -71.90, type: "INT" }, // Hacia afuera
        { id: "T-03", lat: -32.50, lon: -71.75, type: "EXT" }, // Papudo area
        { id: "T-04", lat: -32.80, lon: -72.00, type: "INT" }, // Quintero afuera
        { id: "T-05", lat: -33.10, lon: -71.80, type: "EXT" }, // Valpo area
        { id: "T-06", lat: -33.50, lon: -72.10, type: "INT" }  // San Antonio afuera
    ];

    // 4. LÓGICA DEL SUBMARINO Y MARKOV
    let subPos = { lat: -32.0, lon: -72.2 }; // Empieza al NO
    let subHeading = 160; // Rumbo Sur-Este
    let subSpeed = 0.0005; // Velocidad en grados lat/lon por frame
    let detectionState = false;

    // Motor Predictivo (Partículas de probabilidad)
    class MarkovTracker {
        constructor() {
            this.particles = [];
            this.zNumber = 0.85; // Tu constante del paper
        }

        update(targetLat, targetLon) {
            // Generar partículas alrededor del objetivo estimado
            if (this.particles.length < 50) {
                this.particles.push({
                    lat: targetLat + (Math.random() - 0.5) * 0.1,
                    lon: targetLon + (Math.random() - 0.5) * 0.1,
                    life: 1.0
                });
            }

            // Física de las partículas (Colapso hacia el objetivo)
            this.particles.forEach((p, i) => {
                // Convergencia (Kolmogorov flow simulated)
                p.lat += (targetLat - p.lat) * 0.05 * this.zNumber;
                p.lon += (targetLon - p.lon) * 0.05 * this.zNumber;
                p.life -= 0.02;
                if(p.life <= 0) this.particles.splice(i, 1);
            });
        }
    }

    const tracker = new MarkovTracker();

    // 5. BUCLE DE ANIMACIÓN
    function animate() {
        // A. Limpiar Canvas
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // B. Actualizar Posición Submarino (Simulación Física)
        // Convertir rumbo a movimiento Lat/Lon
        let rad = subHeading * (Math.PI / 180);
        subPos.lat += Math.cos(rad) * subSpeed; // Lat es Y (invertido en mapa pero ok para sim)
        subPos.lon += Math.sin(rad) * subSpeed; // Lon es X

        // Rebote simple si se sale mucho
        if(subPos.lat < -34 || subPos.lat > -31) subHeading += 180;
        
        // C. Proyectar Coordenadas a Pixeles (La magia de Leaflet + Canvas)
        // Obtenemos el punto X,Y actual del submarino en la pantalla
        const subPoint = map.latLngToContainerPoint([subPos.lat, subPos.lon]);

        // D. DIBUJAR BOYAS
        let activeDetection = false;
        
        buoys.forEach(b => {
            const point = map.latLngToContainerPoint([b.lat, b.lon]);
            
            // Solo dibujar si está dentro de la pantalla
            if (point.x > -50 && point.x < canvas.width + 50 && point.y > -50 && point.y < canvas.height + 50) {
                
                // Anillos de Rango (Calculados en Pixeles para que escalen con el zoom no es trivial, 
                // pero para efecto visual fijo usaremos pixeles)
                // Para hacerlo realista geográficamente, deberíamos calcular metros a pixeles según zoom.
                // Usaremos una aproximación simple basada en zoom.
                let zoomScale = Math.pow(2, map.getZoom() - 9); 
                let rangePx = 60 * zoomScale; // 60px base al zoom 9

                // Detectar si el sub está en rango
                let dx = subPoint.x - point.x;
                let dy = subPoint.y - point.y;
                let dist = Math.sqrt(dx*dx + dy*dy);

                if (dist < rangePx) {
                    activeDetection = true;
                    // Línea de contacto
                    ctx.strokeStyle = "red";
                    ctx.lineWidth = 2;
                    ctx.beginPath(); ctx.moveTo(point.x, point.y); ctx.lineTo(subPoint.x, subPoint.y); ctx.stroke();
                    
                    // Boya en Alerta
                    ctx.fillStyle = "red";
                    ctx.beginPath(); ctx.arc(point.x, point.y, 6, 0, Math.PI*2); ctx.fill();
                    
                    // Círculo de rango rojo
                    ctx.strokeStyle = "rgba(255, 0, 0, 0.5)";
                    ctx.beginPath(); ctx.arc(point.x, point.y, rangePx, 0, Math.PI*2); ctx.stroke();
                } else {
                    // Boya Normal (Cyan)
                    ctx.fillStyle = "#00ffcc";
                    ctx.beginPath(); ctx.arc(point.x, point.y, 4, 0, Math.PI*2); ctx.fill();
                    
                    // Círculo de rango pasivo (punteado)
                    ctx.strokeStyle = "rgba(0, 255, 204, 0.2)";
                    ctx.setLineDash([5, 5]);
                    ctx.beginPath(); ctx.arc(point.x, point.y, rangePx, 0, Math.PI*2); ctx.stroke();
                    ctx.setLineDash([]);
                }

                // Texto ID
                ctx.fillStyle = "#fff";
                ctx.font = "10px Monospace";
                ctx.fillText(b.id, point.x + 10, point.y - 10);
            }
        });

        // E. DIBUJAR MARKOV TRACKER (NUBE PREDICTIVA)
        if (activeDetection) {
            tracker.update(subPos.lat, subPos.lon);
            ctx.fillStyle = "rgba(0, 255, 255, 0.4)";
            tracker.particles.forEach(p => {
                let pPoint = map.latLngToContainerPoint([p.lat, p.lon]);
                ctx.beginPath();
                ctx.arc(pPoint.x, pPoint.y, 2 * p.life, 0, Math.PI*2);
                ctx.fill();
            });

            // Dibujar Submarino (Identificado)
            ctx.strokeStyle = "#ff3333";
            ctx.lineWidth = 2;
            ctx.strokeRect(subPoint.x - 10, subPoint.y - 10, 20, 20); // Caja de target
            ctx.fillStyle = "#ff3333";
            ctx.font = "10px Monospace";
            ctx.fillText("CONTACT-S42", subPoint.x + 15, subPoint.y);
            
            updateUI(true);
        } else {
            updateUI(false);
        }

        requestAnimationFrame(animate);
    }

    // 6. ACTUALIZAR INTERFAZ
    function updateUI(detected) {
        if (detected && !detectionState) {
            detectionState = true;
            document.getElementById('alert-box').style.display = 'block';
            document.getElementById('ui-id').innerText = "CONTACT-X1";
            document.getElementById('ui-id').style.color = "red";
            document.getElementById('ui-conf').innerText = "98.4% (HIGH)";
            document.getElementById('ui-conf').style.color = "red";
        } else if (!detected && detectionState) {
            detectionState = false;
            document.getElementById('alert-box').style.display = 'none';
            document.getElementById('ui-id').innerText = "--";
            document.getElementById('ui-conf').innerText = "0%";
            document.getElementById('ui-conf').style.color = "#fff";
        }

        if (detected) {
            document.getElementById('ui-coord').innerText = `${subPos.lat.toFixed(4)}S ${subPos.lon.toFixed(4)}W`;
            document.getElementById('ui-hdg').innerText = `${subHeading}°`;
            document.getElementById('ui-spd').innerText = "19 KTS";
        }
    }

    // Resetear posición para demostración
    window.resetSim = function() {
        subPos = { lat: -32.0, lon: -72.2 };
        subHeading = 160;
        detectionState = false;
    };

    // Manejar eventos del mapa para redibujar rápido si se arrastra
    map.on('move', () => {
        // En animaciones complejas, a veces conviene pausar o limpiar, 
        // pero nuestro animate() corre a 60fps y se adaptará solo.
    });

    // INICIAR
    animate();

</script>
</body>
</html>
