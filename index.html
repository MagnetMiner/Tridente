<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZORD S.p.A. | CIC TRIDENTE v2.0</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <style>
        body { margin: 0; padding: 0; background: #020406; font-family: 'Courier New', monospace; overflow: hidden; }
        #map { height: 100vh; width: 100%; z-index: 1; background: #0b0f14; }

        /* HUD TÁCTICO */
        #hud {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 350px;
            background: rgba(8, 12, 16, 0.95);
            border: 1px solid #005555;
            border-left: 4px solid #00ffff;
            padding: 20px;
            z-index: 1000;
            color: #ccffff;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.1);
        }

        h1 { margin: 0 0 5px 0; font-size: 18px; color: #00ffff; letter-spacing: 2px; }
        h2 { margin: 0 0 15px 0; font-size: 11px; color: #668888; text-transform: uppercase; border-bottom: 1px solid #334444; padding-bottom: 5px;}

        .stat-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 12px; }
        .stat-val { font-weight: bold; color: #fff; }
        .alert { color: #ff3333; animation: flash 1s infinite; font-weight: bold; }
        .warning { color: #ffd700; }
        
        .zone-legend { display: flex; align-items: center; margin-top: 5px; font-size: 10px; color: #88aaaa; }
        .dot { width: 8px; height: 8px; border-radius: 50%; margin-right: 8px; display: inline-block; }

        button {
            width: 100%;
            background: #002a3a;
            color: #00ffff;
            border: 1px solid #00ffff;
            padding: 10px;
            cursor: pointer;
            margin-top: 15px;
            font-family: inherit;
            font-weight: bold;
            text-transform: uppercase;
            transition: all 0.3s;
        }
        button:hover { background: #00ffff; color: #000; box-shadow: 0 0 15px #00ffff; }

        @keyframes flash { 0% { opacity: 1; } 50% { opacity: 0.3; } 100% { opacity: 1; } }
        .buoy-label { background: none; border: none; color: #00ffff; font-weight: bold; text-shadow: 0 0 3px #000; font-family: monospace; font-size: 10px; }
    </style>
</head>
<body>

    <div id="hud">
        <h1>ZORD TRIDENTE</h1>
        <h2>MATRIZ ZIGZAG | DEFENSA EN PROFUNDIDAD</h2>

        <div class="stat-row">
            <span>SISTEMA:</span> <span class="stat-val" style="color:#00ff00">NOMINAL</span>
        </div>
        <div class="stat-row">
            <span>MODO:</span> <span class="stat-val">ACÚSTICO PASIVO</span>
        </div>
        
        <hr style="border-color: #004444; margin: 15px 0;">
        
        <div class="stat-row">
            <span>CONTACTO ID:</span> <span class="stat-val" id="tgt-id">---</span>
        </div>
        <div class="stat-row">
            <span>COORD GPS:</span> <span class="stat-val" id="tgt-coords">---</span>
        </div>
        <div class="stat-row">
            <span>RUMBO (HDG):</span> <span class="stat-val" id="tgt-hdg">---</span>
        </div>
        <div class="stat-row">
            <span>VELOCIDAD:</span> <span class="stat-val" id="tgt-spd">---</span>
        </div>
        <div class="stat-row">
            <span>ESTADO:</span> <span class="stat-val" id="tgt-depth">---</span>
        </div>
        <div class="stat-row">
            <span>CONFIANZA:</span> <span class="stat-val" id="tgt-conf">0%</span>
        </div>
        
        <hr style="border-color: #004444; margin: 15px 0;">

        <div class="stat-row">
            <span>TRIANGULACIÓN:</span> <span class="stat-val" id="tgt-lock">ESPERANDO...</span>
        </div>
        <div class="stat-row">
            <span>CLASIFICACIÓN:</span> <span class="stat-val" id="tgt-class">---</span>
        </div>

        <button onclick="startSimulation()">INICIAR SIMULACIÓN DE INCURSIÓN</button>
        
        <div class="zone-legend"><span class="dot" style="background:#00ffff; opacity:0.3"></span> ZONA PRIMARIA (ID) - 35KM</div>
        <div class="zone-legend"><span class="dot" style="border:1px dashed #ffd700"></span> ZONA SECUNDARIA (ALERTA) - 70KM</div>
    </div>

    <div id="map"></div>

    <script>
        // 1. INICIALIZAR MAPA
        const map = L.map('map', { zoomControl: false, attributionControl: false }).setView([-32.800, -72.200], 8);

        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom: 19, opacity: 0.9 }).addTo(map);

        // 2. CONFIGURACIÓN ESTRATÉGICA ZIGZAG
        const buoys = [
            { id: "T-01 (EXT)", lat: -32.00, lon: -72.40 },
            { id: "T-02 (INT)", lat: -32.30, lon: -71.95 },
            { id: "T-03 (EXT)", lat: -32.60, lon: -72.45 },
            { id: "T-04 (INT)", lat: -32.90, lon: -72.00 },
            { id: "T-05 (EXT)", lat: -33.20, lon: -72.50 },
            { id: "T-06 (INT)", lat: -33.50, lon: -72.05 }
        ];

        const buoyLayers = [];
        const R_PRIMARY = 35000; 
        const R_SECONDARY = 70000;
        const COAST_LIMIT = -71.75; // Límite para no tocar tierra

        buoys.forEach(b => {
            // Zona Primaria
            const pZone = L.circle([b.lat, b.lon], { color: '#00ffff', fillColor: '#00ffff', fillOpacity: 0.08, radius: R_PRIMARY, weight: 1 }).addTo(map);
            // Zona Secundaria
            const sZone = L.circle([b.lat, b.lon], { color: '#ffd700', fillColor: 'transparent', fillOpacity: 0, radius: R_SECONDARY, weight: 1, dashArray: '4, 8' }).addTo(map);
            // Marcador Central
            L.circleMarker([b.lat, b.lon], { color: '#00ffff', fillColor: '#000', fillOpacity: 1, radius: 4 }).addTo(map).bindTooltip(b.id, {permanent: true, direction: 'top', className: 'buoy-label', offset: [0, -10]});
            
            buoyLayers.push({ data: b, pZone: pZone, sZone: sZone });
        });

        // Conexión Zigzag visual
        L.polyline(buoys.map(b => [b.lat, b.lon]), {color: '#004444', weight: 1, dashArray: '5, 10'}).addTo(map);

        // 3. LÓGICA DE SIMULACIÓN
        let targetMarker = null;
        let simInterval = null;
        let tgt = { lat: -31.80, lon: -72.80, heading: 135, speed: 18, depth: "SURFACE" };

        function startSimulation() {
            if(simInterval) clearInterval(simInterval);
            if(targetMarker) map.removeLayer(targetMarker);
            
            // Reiniciar objetivo
            tgt = { 
                lat: -31.80, 
                lon: -72.80, 
                heading: 140, 
                speed: 12 + Math.floor(Math.random() * 20),
                depth: Math.random() > 0.5 ? "SUBMERGED (SSK)" : "SURFACE (CIV)"
            };

            const shipIcon = L.divIcon({
                className: 'custom-icon',
                html: `<div style="width: 0; height: 0; border-left: 6px solid transparent; border-right: 6px solid transparent; border-bottom: 14px solid #ff3333; transform: rotate(${tgt.heading}deg); filter: drop-shadow(0 0 5px red);"></div>`,
                iconSize: [12, 14]
            });

            targetMarker = L.marker([tgt.lat, tgt.lon], {icon: shipIcon}).addTo(map);

            simInterval = setInterval(() => {
                // Movimiento (Evitando tierra continental)
                let newLat = tgt.lat - (tgt.speed * 0.0001);
                let newLon = tgt.lon + (tgt.speed * 0.00006);

                // Bloqueo de coordenadas continentales
                if (newLon < COAST_LIMIT) {
                    tgt.lat = newLat;
                    tgt.lon = newLon;
                } else {
                    // Si llega a la costa, navega hacia el sur paralelo a Chile
                    tgt.lat = newLat;
                    tgt.heading = 180;
                }

                targetMarker.setLatLng([tgt.lat, tgt.lon]);
                checkSensors(tgt);
            }, 100);
        }

        function checkSensors(tgt) {
            let activeBuoys = [];
            let classification = "---";

            buoyLayers.forEach(b => {
                const dist = map.distance([tgt.lat, tgt.lon], [b.data.lat, b.data.lon]);

                // Reset visual
                b.sZone.setStyle({color: '#ffd700', weight: 1});
                b.pZone.setStyle({color: '#00ffff', fillColor: '#00ffff', fillOpacity: 0.08});

                if (dist < R_SECONDARY) {
                    b.sZone.setStyle({color: '#ff3333', weight: 2});
                    activeBuoys.push(b);
                }
                if (dist < R_PRIMARY) {
                    b.pZone.setStyle({color: '#ff3333', fillColor: '#ff3333', fillOpacity: 0.3});
                    classification = (tgt.depth.includes("SUBMERGED")) ? "SUBMARINO CLASE KILO" : "BUQUE MOTOR INDUSTRIAL";
                }
            });

            updateHUD(activeBuoys, classification);
        }

        function updateHUD(activeBuoys, classification) {
            const idEl = document.getElementById('tgt-id');
            const coordEl = document.getElementById('tgt-coords');
            const hdgEl = document.getElementById('tgt-hdg');
            const spdEl = document.getElementById('tgt-spd');
            const depthEl = document.getElementById('tgt-depth');
            const confEl = document.getElementById('tgt-conf');
            const lockEl = document.getElementById('tgt-lock');
            const classEl = document.getElementById('tgt-class');

            if (activeBuoys.length > 0) {
                idEl.innerText = "CONTACT-X1";
                idEl.className = "stat-val alert";
                
                // Información requerida
                coordEl.innerText = `${Math.abs(tgt.lat).toFixed(4)}°S ${Math.abs(tgt.lon).toFixed(4)}°W`;
                hdgEl.innerText = tgt.heading + "°";
                spdEl.innerText = tgt.speed + " KTS";
                depthEl.innerText = tgt.depth;
                depthEl.style.color = tgt.depth.includes("SUBMERGED") ? "#00ffff" : "#fff";

                // Lógica de confianza solicitada
                if (activeBuoys.length === 1) {
                    confEl.innerText = "60% (APROX)";
                    confEl.className = "stat-val warning";
                    lockEl.innerText = "TRAZADO SIMPLE";
                    lockEl.className = "stat-val warning";
                } else {
                    confEl.innerText = "100% (NOMINAL)";
                    confEl.className = "stat-val alert";
                    lockEl.innerText = "!!! JOINT LOCK !!!";
                    lockEl.className = "stat-val alert";
                }

                classEl.innerText = classification;
                classEl.style.color = (classification !== "---") ? "#ff9900" : "#fff";

            } else {
                // Reset HUD si no hay detección
                idEl.innerText = "---"; idEl.className = "stat-val";
                coordEl.innerText = "---";
                hdgEl.innerText = "---";
                spdEl.innerText = "---";
                depthEl.innerText = "---";
                confEl.innerText = "0%"; confEl.className = "stat-val";
                lockEl.innerText = "ESCANEO PASIVO"; lockEl.className = "stat-val";
                classEl.innerText = "---";
            }
        }
    </script>
</body>
</html>
