<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZORD TRIDENTE v10 | FOG OF WAR</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    
    <style>
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; font-family: 'Segoe UI', 'Courier New', monospace; background: #000; }
        #main-container { display: flex; height: 100vh; width: 100vw; }

        /* PANEL IZQUIERDO */
        #control-panel {
            width: 440px;
            background: #080a0c;
            border-right: 2px solid #004433;
            color: #00ffcc;
            display: flex; flex-direction: column;
            z-index: 1000;
            box-shadow: 10px 0 30px rgba(0,0,0,0.9);
            font-size: 12px;
        }

        .panel-header { padding: 15px; background: linear-gradient(90deg, #001a11 0%, #000 100%); border-bottom: 1px solid #004433; }
        h1 { font-size: 20px; margin: 0; letter-spacing: 2px; text-shadow: 0 0 5px #00ffcc; }
        
        .panel-content { padding: 15px; flex-grow: 1; overflow-y: auto; }

        /* DATA GRIDS */
        .section-title { color: #008866; border-bottom: 1px solid #004433; margin-bottom: 10px; padding-bottom: 3px; font-weight: bold; }
        
        .data-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .data-box { background: rgba(0,20,20,0.4); border: 1px solid #003322; padding: 8px; position: relative; }
        .data-box.locked { border-color: #00ffcc; background: rgba(0, 50, 50, 0.3); }
        
        .lbl { font-size: 9px; color: #669988; display: block; margin-bottom: 2px; text-transform: uppercase; }
        .val { font-size: 13px; color: #fff; font-weight: bold; font-family: 'Courier New'; }
        
        /* ESTADOS DE TEXTO */
        .txt-blur { color: #555; filter: blur(2px); user-select: none; } /* Texto oculto por niebla */
        .txt-alert { color: #ff3300; }
        .txt-warn { color: #ffcc00; }
        .txt-ok { color: #00ffcc; }

        /* BOTONES */
        .action-btn {
            background: #002211; border: 1px solid #00ffcc; color: #00ffcc; 
            padding: 12px; width: 100%; cursor: pointer; font-weight: bold; margin-top: 10px;
            display: flex; align-items: center; justify-content: center; gap: 10px; transition: 0.3s;
        }
        .action-btn:hover { background: #00ffcc; color: #000; }
        .action-btn.disabled { opacity: 0.3; pointer-events: none; border-color: #555; }

        /* MAPA */
        #map-container { flex-grow: 1; position: relative; background: #000; cursor: crosshair; }
        #map { height: 100%; width: 100%; background: #000; }
        #tactical-overlay { position: absolute; top: 0; left: 0; pointer-events: none; z-index: 500; }

        /* MENU FLOTANTE */
        #engage-menu {
            position: absolute; display: none; background: rgba(0, 10, 10, 0.95);
            border: 1px solid #ff3300; width: 220px; z-index: 2000;
            top: 50%; left: 50%; transform: translate(-50%, -50%);
        }
        .menu-opt { padding: 12px; color: #fff; cursor: pointer; border-bottom: 1px solid #333; }
        .menu-opt:hover { background: #ff3300; color: #000; }

    </style>
</head>
<body>

<div id="main-container">
    <div id="control-panel">
        <div class="panel-header">
            <h1>ZORD TRIDENTE <span style="font-size:10px; color:#555">v10</span></h1>
            <div style="font-size:10px; color:#008866">FOG OF WAR | PROGRESSIVE TRACKING</div>
        </div>

        <div class="panel-content">
            
            <div class="section-title">FIRMA ACÚSTICA (RAW DATA)</div>
            <div class="data-grid">
                <div class="data-box">
                    <span class="lbl">INTENSIDAD DE SEÑAL</span>
                    <span class="val" id="ui-db">--</span>
                </div>
                <div class="data-box">
                    <span class="lbl">DOPPLER (VEL RELATIVA)</span>
                    <span class="val" id="ui-doppler">--</span>
                </div>
                <div class="data-box">
                    <span class="lbl">ANÁLISIS DE ESPECTRO</span>
                    <span class="val" id="ui-rpm">--</span>
                </div>
                <div class="data-box">
                    <span class="lbl">ESTADO DE MEDIO</span>
                    <span class="val" id="ui-depth">--</span>
                </div>
            </div>

            <div class="section-title">SOLUCIÓN DE TIRO (GPS/TMA)</div>
            <div class="data-grid">
                <div class="data-box">
                    <span class="lbl">UBICACIÓN EXACTA</span>
                    <span class="val txt-blur" id="ui-gps">32.444S 72.111W</span>
                </div>
                <div class="data-box">
                    <span class="lbl">ETA PUERTO (SAN ANTONIO)</span>
                    <span class="val txt-blur" id="ui-eta">04H 20M</span>
                </div>
                <div class="data-box">
                    <span class="lbl">VELOCIDAD ABSOLUTA</span>
                    <span class="val txt-blur" id="ui-spd">14 KTS</span>
                </div>
                <div class="data-box">
                    <span class="lbl">MÉTRICA Z (PRECISIÓN)</span>
                    <span class="val" id="ui-entropy">INCERTIDUMBRE</span>
                </div>
            </div>

            <div class="section-title">UNIDADES DE RESPUESTA</div>
            <div class="data-box" style="margin-bottom:10px; border-color:#005544">
                <span class="lbl">UNIDAD DESPLEGADA</span>
                <span class="val" id="ui-unit-name">NINGUNA</span>
            </div>
            <div class="data-box" style="margin-bottom:10px; border-color:#005544">
                <span class="lbl">TAT (TIEMPO AL OBJETIVO)</span>
                <span class="val" id="ui-tat" style="color:#0088ff">--:--</span>
            </div>

            <button id="btn-engage" class="action-btn disabled" onclick="showMenu()">
                <i class="fas fa-crosshairs"></i> ENGAGE TARGET
            </button>
            <div style="font-size:9px; color:#555; text-align:center; margin-top:5px;">
                * ENGAGE REQUIERE TRIANGULACIÓN (2+ BOYAS)
            </div>

        </div>
    </div>

    <div id="map-container">
        <div id="map"></div>
        <canvas id="tactical-overlay"></canvas>
        
        <div id="engage-menu">
            <div style="padding:10px; background:#200; color:#f00; font-weight:bold; border-bottom:1px solid #500">OPCIONES ENGAGE</div>
            <div class="menu-opt" onclick="dispatchUnit('HELO')"><i class="fas fa-helicopter"></i> HELICÓPTERO (RÁPIDO)</div>
            <div class="menu-opt" onclick="dispatchUnit('PATRULLA')"><i class="fas fa-ship"></i> PATRULLA (LENTO)</div>
            <div class="menu-opt" onclick="closeMenu()" style="color:#aaa">CANCELAR</div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // 1. MAPA
    const map = L.map('map', { zoomControl: false, attributionControl: false, center: [-32.8, -72.4], zoom: 8 });
    L.control.zoom({ position: 'topright' }).addTo(map);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom: 19, subdomains: 'abcd' }).addTo(map);

    const canvas = document.getElementById('tactical-overlay');
    const ctx = canvas.getContext('2d');
    function resizeCanvas() {
        const container = document.getElementById('map-container');
        canvas.width = container.offsetWidth; canvas.height = container.offsetHeight;
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    // 2. BOYAS (GEOMETRÍA OPTIMIZADA)
    const buoys = [
        { id: "B1", lat: -32.00, lon: -72.10 }, { id: "B2", lat: -32.30, lon: -72.90 }, 
        { id: "B3", lat: -32.65, lon: -72.15 }, { id: "B4", lat: -32.95, lon: -72.95 }, 
        { id: "B5", lat: -33.30, lon: -72.20 }, { id: "B6", lat: -33.65, lon: -73.00 }  
    ];

    // 3. VARIABLES DE SIMULACIÓN
    let sub = {
        lat: -31.8, lon: -73.1, heading: 150, speedDeg: 0.00015,
        rpm: 120, depth: "SUMERGIDO",
        lastDistances: [999,999,999,999,999,999] // Para calcular Doppler
    };

    let blueForce = null; // Unidad aliada
    
    // Motor de Niebla (Fog of War)
    let detectionState = 0; // 0=Nada, 1=Mono(Borroso), 2=Stereo(Preciso)
    let activeBuoys = [];   // Cuales boyas lo escuchan

    // 4. LÓGICA DE DETECCIÓN (-15dB Logic)
    // El paper dice: podemos detectar bajo el ruido. 
    // Umbral Visual (Anillos mapa) = 35km (Rojo) y 70km (Amarillo).
    // Pero matemáticamente detectamos "Firma Espectral" un poco más allá, aunque débil.
    
    function calculateSignal(distKm) {
        // Modelo simplificado de Pérdida de Propagación
        // Ruido Base = 0 dB relativo.
        // Fuente = 120 dB.
        // Perdida = 20 log(R).
        // Adaptado a la escala visual de 70km.
        // Si dist < 35km -> > +10dB
        // Si dist 35-70km -> -5dB a +10dB
        // Si dist 70-80km -> -15dB a -5dB (Detectado por paper Z, pero muy debil)
        
        let signal = 0;
        if (distKm > 80) return -99; // Indetectable
        
        // Mapeo lineal simple para la demo
        if (distKm < 10) signal = 30;
        else if (distKm < 35) signal = 15 + (35-distKm)*0.6;
        else if (distKm < 70) signal = -5 + (70-distKm)*0.57; // -5 a +15
        else signal = -15 + (80-distKm); // -15 a -5 (Zona Z-Paper)
        
        return Math.round(signal);
    }

    // 5. ANIMACIÓN LOOP
    function animate() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // --- MOVER SUBMARINO ---
        sub.lat += Math.cos(sub.heading*Math.PI/180)*sub.speedDeg;
        sub.lon += Math.sin(sub.heading*Math.PI/180)*sub.speedDeg;
        if(sub.lon > -71.65) { sub.heading = 200 + Math.random()*40; sub.lon = -71.67; } // Costa
        if(sub.lat < -34 || sub.lat > -31.5) sub.heading += 120; // Limites
        
        // --- CÁLCULOS DE SENSORES ---
        activeBuoys = [];
        let maxSignal = -99;
        let closestBuoy = null;

        buoys.forEach((b, index) => {
            const center = map.latLngToContainerPoint([b.lat, b.lon]);
            
            // Distancia Real Geodésica (aprox) para física
            const distDeg = Math.hypot(sub.lat - b.lat, sub.lon - b.lon);
            const distKm = distDeg * 111; // 1 deg ~ 111km
            
            // 1. Calcular dB
            const db = calculateSignal(distKm);
            
            // 2. Calcular Doppler (Comparar con frame anterior)
            let doppler = "ESTABLE";
            if (distDeg < sub.lastDistances[index]) doppler = "ACERCANDO (+)";
            else if (distDeg > sub.lastDistances[index]) doppler = "ALEJANDO (-)";
            sub.lastDistances[index] = distDeg;

            // 3. Determinar detección (-15dB umbral del paper)
            if (db > -15) {
                activeBuoys.push({ id: b.id, db: db, doppler: doppler, x: center.x, y: center.y });
                if(db > maxSignal) { maxSignal = db; closestBuoy = b; }
            }

            // DIBUJAR ANILLOS DE ALCANCE (Visual Táctico)
            // Solo dibujamos los anillos, NO la linea roja al objetivo a menos que haya detección
            // Calcular pixeles
            const p35 = map.latLngToContainerPoint([b.lat, b.lon+0.37]);
            const r35 = Math.abs(p35.x - center.x);
            
            ctx.beginPath(); ctx.arc(center.x, center.y, r35, 0, Math.PI*2);
            ctx.strokeStyle = "rgba(0, 100, 80, 0.3)"; ctx.stroke();
            
            // Icono Boya
            ctx.fillStyle = (db > -15) ? "#00ffcc" : "#555"; // Se ilumina si detecta algo
            ctx.beginPath(); ctx.arc(center.x, center.y, 4, 0, Math.PI*2); ctx.fill();
        });

        // --- ESTADO DE "FOG OF WAR" ---
        detectionState = activeBuoys.length >= 2 ? 2 : (activeBuoys.length === 1 ? 1 : 0);

        // --- RENDERIZADO TÁCTICO SEGÚN ESTADO ---
        const subPx = map.latLngToContainerPoint([sub.lat, sub.lon]);

        if (detectionState === 0) {
            // NADA VISIBLE
            updateDashboard(null);
        } 
        else if (detectionState === 1) {
            // ESTADO 1: CONTACTO MONO-AURAL (Borroso)
            const b = activeBuoys[0];
            
            // Dibujar Linea de Marcación (Bearing Line) desde la boya hacia el objetivo
            // No mostramos la distancia exacta, solo la dirección
            const angle = Math.atan2(subPx.y - b.y, subPx.x - b.x);
            const endX = b.x + Math.cos(angle) * 1000; // Linea infinita
            const endY = b.y + Math.sin(angle) * 1000;

            ctx.beginPath(); ctx.moveTo(b.x, b.y); ctx.lineTo(endX, endY);
            ctx.strokeStyle = "rgba(0, 255, 255, 0.3)"; ctx.setLineDash([10, 10]); ctx.stroke(); ctx.setLineDash([]);

            // Dibujar "Nube de Incertidumbre" (Area Probable)
            // Un circulo cian difuso alrededor del objetivo, pero grande
            ctx.fillStyle = "rgba(0, 255, 255, 0.15)";
            ctx.beginPath(); ctx.arc(subPx.x, subPx.y, 40, 0, Math.PI*2); ctx.fill(); // Radio 40px incertidumbre
            
            // Texto en mapa
            ctx.fillStyle = "#00ffcc"; ctx.font = "10px Courier";
            ctx.fillText(`CONTACTO POSIBLE (${b.db}dB)`, subPx.x + 20, subPx.y - 20);

            updateDashboard({ state: 1, db: b.db, doppler: b.doppler });
        } 
        else if (detectionState === 2) {
            // ESTADO 2: TRIANGULACIÓN (Preciso)
            
            // Dibujar Lineas de Triangulación
            activeBuoys.forEach(b => {
                ctx.beginPath(); ctx.moveTo(b.x, b.y); ctx.lineTo(subPx.x, subPx.y);
                ctx.strokeStyle = "rgba(255, 50, 50, 0.6)"; ctx.lineWidth = 1; ctx.stroke();
            });

            // Dibujar ROMBO TÁCTICO (Símbolo Exacto)
            ctx.save();
            ctx.translate(subPx.x, subPx.y);
            ctx.rotate((sub.heading-90)*Math.PI/180);
            
            ctx.strokeStyle = "#ff3300"; ctx.lineWidth = 2;
            ctx.beginPath(); ctx.moveTo(0,-12); ctx.lineTo(10,0); ctx.lineTo(0,12); ctx.lineTo(-10,0); ctx.closePath(); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(0,-12); ctx.lineTo(0,-25); ctx.stroke(); // Vector velocidad
            
            ctx.restore();

            // Etiqueta Diferencial dB (Muestra el dB de la boya más fuerte)
            const strongest = activeBuoys.reduce((prev, curr) => prev.db > curr.db ? prev : curr);
            ctx.fillStyle = "#ffcc00"; ctx.font = "bold 11px Courier";
            ctx.fillText(`HARD LOCK [${strongest.db}dB]`, subPx.x + 15, subPx.y);

            updateDashboard({ state: 2, db: strongest.db, doppler: "N/A (GPS LOCK)" });
        }


        // --- DIBUJAR BLUE FORCE (SI EXISTE) ---
        if (blueForce) {
            // Mover unidad
            const dx = sub.lat - blueForce.lat;
            const dy = sub.lon - blueForce.lon;
            const dist = Math.hypot(dx, dy);
            
            if (dist > 0.01) {
                blueForce.lat += (dx / dist) * blueForce.speed;
                blueForce.lon += (dy / dist) * blueForce.speed;
            }

            const bfPx = map.latLngToContainerPoint([blueForce.lat, blueForce.lon]);
            
            // Linea TAT
            ctx.strokeStyle = "#0088ff"; ctx.setLineDash([5,5]);
            ctx.beginPath(); ctx.moveTo(bfPx.x, bfPx.y); ctx.lineTo(subPx.x, subPx.y); ctx.stroke(); ctx.setLineDash([]);
            
            // Icono
            ctx.fillStyle = "#0088ff"; ctx.fillRect(bfPx.x-5, bfPx.y-5, 10, 10);
            
            // Calcular TAT (Tiempo real estimado)
            // Distancia restante / Velocidad
            const framesRemaining = dist / blueForce.speed;
            const secondsRemaining = Math.round(framesRemaining / 60); // Asumiendo 60fps
            const min = Math.floor(secondsRemaining / 60);
            const sec = secondsRemaining % 60;
            
            // Actualizar UI TAT
            document.getElementById('ui-tat').innerText = `T-${min.toString().padStart(2,'0')}:${sec.toString().padStart(2,'0')}`;
        }

        requestAnimationFrame(animate);
    }

    // 6. ACTUALIZAR HUD (LÓGICA FOG OF WAR)
    function updateDashboard(data) {
        const btnEngage = document.getElementById('btn-engage');

        if (!data) {
            // NADA DETECTADO
            resetUI();
            return;
        }

        // DATOS COMUNES (Estado 1 y 2)
        // dB y Doppler siempre visibles si hay al menos 1 boya
        document.getElementById('ui-db').innerText = (data.db > 0 ? "+" : "") + data.db + " dB";
        document.getElementById('ui-db').className = "val " + (data.db > 0 ? "txt-alert" : "txt-warn");
        
        document.getElementById('ui-doppler').innerText = data.doppler;
        document.getElementById('ui-rpm').innerText = "120-130 (DIESEL)"; // Análisis espectral funciona con 1 boya
        document.getElementById('ui-depth').innerText = sub.depth;

        // DATOS EXCLUSIVOS ESTADO 2 (TRIANGULACIÓN)
        if (data.state === 2) {
            // DESBLOQUEAR SOLUCIÓN DE TIRO
            document.getElementById('ui-gps').className = "val txt-alert";
            document.getElementById('ui-gps').innerText = `${sub.lat.toFixed(4)}S ${sub.lon.toFixed(4)}W`;
            
            // ETA A PUERTO (Cálculo Ficticio a San Antonio -33.58)
            const distToPort = Math.hypot(sub.lat - (-33.58), sub.lon - (-71.62)) * 111; // km
            const speedKmh = 14 * 1.852; // 14 kts a kmh
            const hours = distToPort / speedKmh;
            document.getElementById('ui-eta').className = "val txt-alert";
            document.getElementById('ui-eta').innerText = `T-${Math.floor(hours)}H ${Math.round((hours%1)*60)}M`;

            document.getElementById('ui-spd').className = "val txt-warn";
            document.getElementById('ui-spd').innerText = "14.2 KTS";

            document.getElementById('ui-entropy').innerText = "0.85 (Z-LOCK)";
            document.getElementById('ui-entropy').className = "val txt-ok";

            // HABILITAR ENGAGE
            btnEngage.className = "action-btn"; // Activar botón
        } else {
            // BLOQUEAR SOLUCIÓN DE TIRO (FOG OF WAR)
            document.getElementById('ui-gps').className = "val txt-blur";
            document.getElementById('ui-gps').innerText = "???.???S ???.???W";
            
            document.getElementById('ui-eta').className = "val txt-blur";
            document.getElementById('ui-eta').innerText = "--H --M";
            
            document.getElementById('ui-spd').className = "val txt-blur";
            document.getElementById('ui-spd').innerText = "-- KTS";
            
            document.getElementById('ui-entropy').innerText = "ALTA (DISPERSO)";
            document.getElementById('ui-entropy').className = "val";

            // DESHABILITAR ENGAGE
            btnEngage.className = "action-btn disabled";
        }
    }

    function resetUI() {
        document.getElementById('ui-db').innerText = "--";
        document.getElementById('ui-doppler').innerText = "--";
        document.getElementById('ui-rpm').innerText = "--";
        document.getElementById('ui-depth').innerText = "--";
        document.getElementById('ui-gps').innerText = "ESCANANDO...";
        document.getElementById('ui-gps').className = "val";
        document.getElementById('ui-eta').innerText = "--";
        document.getElementById('ui-spd').innerText = "--";
        document.getElementById('ui-entropy').innerText = "--";
        document.getElementById('btn-engage').className = "action-btn disabled";
    }

    // 7. FUNCIONES ENGAGE
    function showMenu() { document.getElementById('engage-menu').style.display = 'block'; }
    function closeMenu() { document.getElementById('engage-menu').style.display = 'none'; }
    
    function dispatchUnit(type) {
        closeMenu();
        const speed = type === 'HELO' ? 0.002 : 0.0005; // Helo rápido, Barco lento
        blueForce = { 
            lat: -33.0, lon: -71.6, speed: speed, 
            name: type === 'HELO' ? 'SH-32 COUGAR' : 'OPV-81'
        };
        document.getElementById('ui-unit-name').innerText = blueForce.name;
        document.getElementById('ui-unit-name').className = "val txt-ok";
    }

    animate();
</script>
</body>
</html>
