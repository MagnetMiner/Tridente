<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ZORD TRIDENTE v10 | FOG OF WAR</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
    
    <style>
        body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; font-family: 'Segoe UI', 'Courier New', monospace; background: #000; }
        #main-container { display: flex; height: 100vh; width: 100vw; }

        /* --- PANEL DE CONTROL (HUD) --- */
        #control-panel {
            width: 450px;
            background: #0b1013;
            border-right: 2px solid #004433;
            color: #00ffcc;
            display: flex; flex-direction: column;
            z-index: 1000;
            box-shadow: 10px 0 30px rgba(0,0,0,0.9);
            font-size: 13px;
        }

        .panel-header { padding: 15px; background: linear-gradient(90deg, #002211 0%, #001108 100%); border-bottom: 1px solid #005544; }
        h1 { font-size: 20px; margin: 0; text-shadow: 0 0 5px #00ffcc; letter-spacing: 2px; }
        .mode-indicator { font-size: 11px; font-weight: bold; padding: 4px; background: #003322; display: inline-block; margin-top:5px;}
        
        .panel-content { padding: 15px; flex-grow: 1; overflow-y: auto; }

        /* SECCIONES DE DATOS */
        .section-title { color: #555; border-bottom: 1px solid #333; margin-bottom: 10px; font-size: 11px; font-weight: bold; }
        .data-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 15px; }
        .data-box { background: rgba(0,20,20,0.5); border: 1px solid #004433; padding: 8px; position: relative; }
        
        .lbl { font-size: 10px; color: #008866; display: block; margin-bottom: 2px; }
        .val { font-size: 14px; color: #fff; font-weight: bold; font-family: 'Courier New'; }
        
        /* COLORES DE ESTADO */
        .val.encrypted { color: #555; text-shadow: none; letter-spacing: 3px; } /* Dato oculto */
        .val.partial { color: #ffcc00; } /* Dato parcial */
        .val.locked { color: #ff3300; } /* Dato confirmado */

        /* BOTONES */
        .action-btn {
            background: #002211; border: 1px solid #555; color: #777; 
            padding: 12px; width: 100%; cursor: not-allowed; text-transform: uppercase; 
            font-weight: bold; margin-top: 10px; display: flex; align-items: center; justify-content: center; gap: 10px;
        }
        .action-btn.active { border-color: #ff3300; color: #ff3300; cursor: pointer; }
        .action-btn.active:hover { background: #ff3300; color: #fff; }

        /* MAPA */
        #map-container { flex-grow: 1; position: relative; background: #000; cursor: crosshair; }
        #map { height: 100%; width: 100%; background: #000; }
        #tactical-overlay { position: absolute; top: 0; left: 0; pointer-events: none; z-index: 500; }

    </style>
</head>
<body>

<div id="main-container">
    <div id="control-panel">
        <div class="panel-header">
            <h1>ZORD TRIDENTE v10</h1>
            <div id="sys-mode" class="mode-indicator" style="color:#aaa">ESCANEO PASIVO</div>
        </div>

        <div class="panel-content">
            
            <div class="section-title">FIRMA ACÚSTICA (ANÁLISIS ESPECTRAL)</div>
            <div class="data-grid">
                <div class="data-box"><span class="lbl">RPM MOTOR</span><span class="val" id="ui-rpm">--</span></div>
                <div class="data-box"><span class="lbl">PERFIL</span><span class="val" id="ui-profile">--</span></div>
                <div class="data-box"><span class="lbl">SNR (MAX)</span><span class="val" id="ui-snr">--</span></div>
                <div class="data-box"><span class="lbl">DOPPLER</span><span class="val" id="ui-doppler">--</span></div>
            </div>

            <div class="section-title">SOLUCIÓN DE NAVEGACIÓN (GPS/TMA)</div>
            <div class="data-grid">
                <div class="data-box"><span class="lbl">UBICACIÓN</span><span class="val encrypted" id="ui-pos">NO DATA</span></div>
                <div class="data-box"><span class="lbl">RUMBO</span><span class="val encrypted" id="ui-hdg">---°</span></div>
                <div class="data-box"><span class="lbl">VELOCIDAD ABS</span><span class="val encrypted" id="ui-spd">-- KTS</span></div>
                <div class="data-box"><span class="lbl">ETA PUERTO (S.A.)</span><span class="val encrypted" id="ui-eta">--:--</span></div>
            </div>

            <div class="section-title">FÍSICA DEL CAOS ($Z_I$)</div>
            <div class="data-grid">
                <div class="data-box"><span class="lbl">ENTROPÍA</span><span class="val" id="ui-entropy">MAXIMA</span></div>
                <div class="data-box"><span class="lbl">NÚMERO Z</span><span class="val" id="ui-z">0.000</span></div>
            </div>
            
            <div id="blue-force-panel" style="display:none; border:1px solid #0088ff; padding:10px; margin-bottom:10px; background:rgba(0,50,100,0.3)">
                <span class="lbl" style="color:#0088ff">INTERCEPTOR ASW (SH-32)</span>
                <div style="display:flex; justify-content:space-between; align-items:center">
                    <span style="font-weight:bold; color:#fff">EN CURSO</span>
                    <span id="ui-tat" style="font-family:'Courier New'; font-weight:bold; color:#00ffcc">TAT: 00:00</span>
                </div>
            </div>

            <button id="btn-engage" class="action-btn" onclick="engageTarget()">
                <i class="fas fa-crosshairs"></i> ENGAGE TARGET
            </button>

            <div style="margin-top:20px; font-size:10px; color:#555;">
                * DATOS GPS REQUIEREN TRIANGULACIÓN (2+ NODOS).<br>
                * DETECCIÓN INICIA A -15dB (SUB-RUIDO).
            </div>
        </div>
    </div>

    <div id="map-container">
        <div id="map"></div>
        <canvas id="tactical-overlay"></canvas>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // 1. CONFIGURACIÓN MAPA
    const map = L.map('map', { zoomControl: false, attributionControl: false, center: [-32.8, -72.4], zoom: 8 });
    L.control.zoom({ position: 'topright' }).addTo(map);
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { maxZoom: 19, subdomains: 'abcd' }).addTo(map);

    const canvas = document.getElementById('tactical-overlay');
    const ctx = canvas.getContext('2d');
    function resizeCanvas() {
        const container = document.getElementById('map-container');
        canvas.width = container.offsetWidth; canvas.height = container.offsetHeight;
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    // 2. CONFIGURACIÓN BOYAS (ZIGZAG V9 - INALTERADO)
    const buoys = [
        { id: "B1", lat: -32.00, lon: -72.10 }, 
        { id: "B2", lat: -32.30, lon: -72.90 }, 
        { id: "B3", lat: -32.65, lon: -72.15 }, 
        { id: "B4", lat: -32.95, lon: -72.95 }, 
        { id: "B5", lat: -33.30, lon: -72.20 }, 
        { id: "B6", lat: -33.65, lon: -73.00 }  
    ];
    // Puerto de San Antonio (Referencia para ETA)
    const portLoc = { lat: -33.58, lon: -71.62 };

    // 3. ESTADO DEL SUBMARINO
    let sub = {
        lat: -31.7, lon: -73.0, heading: 150, 
        speedDeg: 0.00018, // ~12 nudos
        rpm: 120,
        depth: "SUMERGIDO",
        activeSources: 0, // Cuantas boyas lo ven
        maxSNR: -99
    };

    let interceptor = null; // Unidad aliada

    // 4. CÁLCULOS MATEMÁTICOS AUXILIARES
    function getDistance(lat1, lon1, lat2, lon2) { // En grados aprox
        return Math.hypot(lat1-lat2, lon1-lon2);
    }
    
    // Simula cálculo de SNR: Base - Perdida por distancia
    // Rango max detección ~ 0.8 grados
    function calculateSNR(dist) {
        // A 0 distancia = +40dB. A 0.8 distancia = -20dB.
        return 40 - (dist * 75); 
    }

    // 5. ANIMACIÓN Y LÓGICA TÁCTICA
    function animate() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // A. MOVIMIENTO SUB
        sub.lat += Math.cos(sub.heading*Math.PI/180)*sub.speedDeg;
        sub.lon += Math.sin(sub.heading*Math.PI/180)*sub.speedDeg;
        // Rebotes
        if(sub.lon > -71.65) { sub.heading = 200 + Math.random()*40; sub.lon = -71.67; }
        if(sub.lat < -34 || sub.lat > -31.5) sub.heading += 120;
        
        // Simulación RPM y Profundidad
        sub.rpm = 100 + Math.round(Math.sin(Date.now()/1000)*5); 
        
        const subPx = map.latLngToContainerPoint([sub.lat, sub.lon]);

        // B. LÓGICA DE DETECCIÓN (EL CEREBRO DEL SISTEMA)
        let activeSources = 0;
        let maxSNR = -100;
        let bestBuoy = null;

        buoys.forEach(b => {
            const center = map.latLngToContainerPoint([b.lat, b.lon]);
            const distDeg = getDistance(sub.lat, sub.lon, b.lat, b.lon);
            const snr = calculateSNR(distDeg);

            // DIBUJAR ANILLOS DE BOYA
            const p35 = map.latLngToContainerPoint([b.lat, b.lon+0.37]);
            const r35 = Math.abs(p35.x - center.x);

            ctx.beginPath(); ctx.arc(center.x, center.y, r35, 0, Math.PI*2);
            ctx.strokeStyle = "rgba(0, 100, 80, 0.3)"; ctx.lineWidth=1; ctx.stroke();
            ctx.fillStyle = "#00ffcc"; ctx.beginPath(); ctx.arc(center.x, center.y, 3, 0, Math.PI*2); ctx.fill();

            // UMBRAL DE DETECCIÓN (-15dB)
            if (snr > -15) {
                activeSources++;
                if(snr > maxSNR) { maxSNR = snr; bestBuoy = b; }

                // Linea de detección (fina si es débil, gruesa si es fuerte)
                let alpha = (snr + 15) / 40; // 0 a 1
                if(alpha>1) alpha=1;
                
                ctx.beginPath(); ctx.moveTo(center.x, center.y); ctx.lineTo(subPx.x, subPx.y);
                ctx.strokeStyle = `rgba(255, ${255-snr*5}, 0, ${alpha})`; 
                ctx.stroke();

                // Etiqueta dB en la boya
                ctx.fillStyle = snr > 0 ? "#ff3300" : "#ffcc00";
                ctx.font = "9px monospace";
                ctx.fillText(Math.round(snr)+"dB", center.x+5, center.y-5);
            }
        });

        sub.activeSources = activeSources;
        sub.maxSNR = maxSNR;

        // C. VISUALIZACIÓN SEGÚN "NIEBLA DE GUERRA"
        if (activeSources === 0) {
            // NADA DETECTADO
            updateHUD_None();

        } else if (activeSources === 1) {
            // DETECCIÓN PARCIAL (1 BOYA) - FOG OF WAR
            // Dibujamos una "Nube de Incertidumbre" en lugar del sub exacto
            const cloudRadius = 40; // Pixeles
            const gradient = ctx.createRadialGradient(subPx.x, subPx.y, 5, subPx.x, subPx.y, cloudRadius);
            gradient.addColorStop(0, "rgba(255, 200, 0, 0.4)");
            gradient.addColorStop(1, "rgba(255, 200, 0, 0)");
            
            ctx.fillStyle = gradient;
            ctx.beginPath(); ctx.arc(subPx.x, subPx.y, cloudRadius, 0, Math.PI*2); ctx.fill();
            
            // Texto de Incertidumbre
            ctx.fillStyle = "#ffcc00"; ctx.font="10px Arial"; ctx.textAlign="center";
            ctx.fillText("?", subPx.x, subPx.y+4);

            // Calcular Doppler Relativo (Acerca/Aleja)
            // Producto punto simple entre vector velocidad sub y vector hacia boya
            const toBuoyLat = bestBuoy.lat - sub.lat;
            const toBuoyLon = bestBuoy.lon - sub.lon;
            // Vector velocidad sub
            const vLat = Math.cos(sub.heading*Math.PI/180);
            const vLon = Math.sin(sub.heading*Math.PI/180);
            
            const dot = (vLat * toBuoyLat) + (vLon * toBuoyLon);
            const doppler = dot > 0 ? "ACERCANDO (BLUE SHIFT)" : "ALEJANDO (RED SHIFT)";

            updateHUD_Partial(sub, doppler);

        } else {
            // DETECCIÓN TOTAL (2+ BOYAS) - SOLUCIÓN DE TIRO
            // Dibujamos el Rombo Táctico Exacto
            ctx.save();
            ctx.translate(subPx.x, subPx.y);
            
            // Simbolo
            ctx.strokeStyle = "#ff3300"; ctx.lineWidth=2;
            ctx.beginPath(); ctx.moveTo(0,-12); ctx.lineTo(10,0); ctx.lineTo(0,12); ctx.lineTo(-10,0); ctx.closePath(); ctx.stroke();
            // Vector
            ctx.rotate((sub.heading-90)*Math.PI/180);
            ctx.beginPath(); ctx.moveTo(0,-12); ctx.lineTo(0,-30); ctx.stroke();
            ctx.restore();

            // Nube Markoviana (Z-Number Visualization)
            ctx.fillStyle = "rgba(0, 255, 255, 0.6)";
            for(let k=0; k<10; k++) {
                ctx.beginPath(); 
                ctx.arc(subPx.x+(Math.random()-0.5)*15, subPx.y+(Math.random()-0.5)*15, 1.5, 0, Math.PI*2); 
                ctx.fill();
            }

            // Calcular ETA
            const distToPort = getDistance(sub.lat, sub.lon, portLoc.lat, portLoc.lon); // grados
            // 0.00018 deg/frame ~ 12 kts. Distancia real ~ distToPort * 60 nm.
            // Simplificado para demo:
            const hours = Math.round(distToPort * 20); 

            updateHUD_Full(sub, hours);
        }

        // D. INTERCEPTOR (BLUE FORCE)
        if(interceptor) {
            // Mover
            const angle = Math.atan2(sub.lon - interceptor.lon, sub.lat - interceptor.lat);
            interceptor.lat += Math.cos(angle) * interceptor.speed;
            interceptor.lon += Math.sin(angle) * interceptor.speed;
            
            const iPx = map.latLngToContainerPoint([interceptor.lat, interceptor.lon]);
            
            // Dibujar
            ctx.fillStyle = "#0088ff"; ctx.fillRect(iPx.x-4, iPx.y-4, 8, 8);
            ctx.strokeStyle="rgba(0,136,255,0.5)"; ctx.beginPath(); ctx.moveTo(iPx.x, iPx.y); ctx.lineTo(subPx.x, subPx.y); ctx.stroke();

            // Calcular TAT (Time to Target)
            const distI = getDistance(interceptor.lat, interceptor.lon, sub.lat, sub.lon);
            const tatSec = Math.round(distI / interceptor.speed); // Frames aprox
            const tatMin = Math.floor(tatSec/60);
            const tatS = tatSec % 60;
            document.getElementById('ui-tat').innerText = `TAT: 00:${tatMin.toString().padStart(2,'0')}`;

            if(distI < 0.005) { alert("IMPACTO CONFIRMADO."); interceptor = null; document.getElementById('blue-force-panel').style.display='none'; }
        }

        requestAnimationFrame(animate);
    }

    // 6. ACTUALIZACIÓN DEL HUD (TEXTOS)
    
    // CASO 0: NADA
    function updateHUD_None() {
        document.getElementById('sys-mode').innerText = "ESCANEO PASIVO - SILENCIO";
        document.getElementById('sys-mode').style.color = "#aaa";
        document.getElementById('sys-mode').style.background = "#222";
        
        setVal('ui-rpm', '--');
        setVal('ui-profile', '--');
        setVal('ui-snr', '--');
        setVal('ui-doppler', '--');
        
        lockData(false); // Ocultar GPS
        
        setVal('ui-entropy', 'MAXIMA');
        setVal('ui-z', '0.000');
        
        btnEnable(false);
    }

    // CASO 1: UNA BOYA (PARCIAL)
    function updateHUD_Partial(s, doppler) {
        document.getElementById('sys-mode').innerText = "CONTACTO UNICO - DATOS PARCIALES";
        document.getElementById('sys-mode').style.color = "#ffcc00";
        document.getElementById('sys-mode').style.background = "#332200";

        setVal('ui-rpm', s.rpm);
        setVal('ui-profile', s.depth); // Superficie/Sumergido se detecta por audio
        setVal('ui-snr', Math.round(s.maxSNR) + " dB");
        setVal('ui-doppler', doppler); // ESTO ES CLAVE
        document.getElementById('ui-doppler').className = "val partial";

        // GPS OCULTO
        lockData(false);

        setVal('ui-entropy', 'ALTA (INCERTIDUMBRE)');
        setVal('ui-z', '0.450 (PRE-SAT)');
        
        btnEnable(false); // No se puede disparar sin solución de tiro
    }

    // CASO 2: FULL (TRIANGULACIÓN)
    function updateHUD_Full(s, etaHours) {
        document.getElementById('sys-mode').innerText = "TRIANGULACIÓN ACTIVA - SOLUCIÓN DE TIRO";
        document.getElementById('sys-mode').style.color = "#ff3300";
        document.getElementById('sys-mode').style.background = "#330000";

        setVal('ui-rpm', s.rpm);
        setVal('ui-profile', "SCORPÈNE (CONFIRMADO)");
        setVal('ui-snr', Math.round(s.maxSNR) + " dB");
        setVal('ui-doppler', "N/A (TRACKING ABSOLUTO)");

        // GPS VISIBLE
        lockData(true);
        setVal('ui-pos', `${s.lat.toFixed(4)}S ${s.lon.toFixed(4)}W`);
        setVal('ui-hdg', Math.round(s.heading) + "°");
        setVal('ui-spd', "12.4 KTS"); // Velocidad real calculada
        setVal('ui-eta', `+${etaHours}h (SAN ANTONIO)`);

        setVal('ui-entropy', 'MINIMA (COLAPSO)');
        setVal('ui-z', '0.852 (SATURADO)');

        btnEnable(true); // FUEGO AUTORIZADO
    }

    // UTILS UI
    function setVal(id, txt) { document.getElementById(id).innerText = txt; }
    
    function lockData(show) {
        const ids = ['ui-pos', 'ui-hdg', 'ui-spd', 'ui-eta'];
        ids.forEach(id => {
            const el = document.getElementById(id);
            if(show) {
                el.className = "val locked";
            } else {
                el.className = "val encrypted";
                el.innerText = "ENCRYPTED";
            }
        });
    }

    function btnEnable(enable) {
        const btn = document.getElementById('btn-engage');
        if(enable) {
            btn.className = "action-btn active";
            btn.innerHTML = '<i class="fas fa-crosshairs"></i> ENGAGE (SOLUCIÓN LISTA)';
        } else {
            btn.className = "action-btn";
            btn.innerHTML = '<i class="fas fa-ban"></i> ENGAGE (REQUIERE TRIANGULACIÓN)';
        }
    }

    // ACCIÓN
    window.engageTarget = function() {
        if(document.getElementById('btn-engage').className.includes('active')) {
            document.getElementById('blue-force-panel').style.display = 'block';
            interceptor = { lat: -33.5, lon: -71.6, speed: 0.0012 }; // Sale de San Antonio
        }
    }

    animate();
</script>
</body>
</html>
